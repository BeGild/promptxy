# PromptXY Web UI 设计文档

> **项目定位**：开源、免费的本地HTTP代理规则管理器
> **核心价值**：可视化管理请求拦截规则，完整记录请求/响应流转过程

---

## 🎯 核心功能理解

### 后端已实现（无需修改）

```
┌─────────────┐
│ CLI工具     │
│ (Claude/Codex/Gemini)│
└──────┬──────┘
       │ HTTP请求
       ↓
┌─────────────────────────────────┐
│  PromptXY 代理 (7070端口)       │
│                                 │
│  1. 捕获原始请求体              │
│  2. 匹配规则                    │
│  3. 应用ops修改                │
│  4. 转发到上游API              │
│  5. 返回响应                    │
└─────────────────────────────────┘
       │
       ↓
┌─────────────────────────────────┐
│  上游API                        │
│  (Anthropic/OpenAI/Google)      │
└─────────────────────────────────┘
```

### Web UI需要补充的功能

#### 1. **请求捕获与查看** ⭐⭐⭐

- 实时捕获经过代理的请求
- 保存原始请求体
- 保存修改后的请求体
- 显示匹配的规则和修改详情

#### 2. **规则可视化编辑** ⭐⭐⭐

- 图形化界面创建/编辑规则
- 条件配置（client/field/method/pathRegex/modelRegex）
- 操作配置（7种操作类型）
- 实时验证规则语法

#### 3. **请求-规则关联预览** ⭐⭐⭐

- 选择历史请求
- 应用当前规则集
- 显示：原始 → 修改后的对比
- 显示哪些规则被触发

#### 4. **持久化存储** ⭐⭐

- 规则配置持久化（JSON文件）
- 请求历史保存（可配置保留数量）
- 修改记录审计
- 导出/导入功能

#### 5. **调试与分析** ⭐

- 请求统计（频率、成功率）
- 规则命中分析
- 性能监控
- 错误日志查看

---

## 📋 详细需求清单

### 功能需求

#### A. 规则管理 (Rule Management)

**1. 规则列表**

- 显示所有规则卡片
- 按client分类筛选
- 搜索规则ID/描述
- 查看规则启用状态
- 快速启用/禁用

**2. 规则编辑器**

- **条件部分**：
  - client选择器（claude/codex/gemini）
  - field选择器（system/instructions）
  - method输入（GET/POST等，可选）
  - pathRegex输入（正则，可选）
  - modelRegex输入（正则，可选）

- **操作部分**：
  - 操作类型选择（7种）
  - 动态表单（根据类型显示不同字段）
  - 支持多操作组合
  - 操作顺序调整（拖拽）

**3. 规则验证**

- 正则语法检查
- 必填字段验证
- 冲突检测（相同条件的规则）
- 预览执行效果

#### B. 请求捕获与查看 (Request Capture)

**1. 实时请求流**

- WebSocket或SSE实时显示新请求
- 显示请求时间、客户端、路径
- 显示规则匹配数量
- 点击查看详情

**2. 请求详情**

- **原始请求体**：完整JSON
- **修改后请求体**：完整JSON
- **差异高亮**：使用颜色标记修改处
- **匹配规则**：列出触发的规则ID和操作
- **响应信息**：状态码、耗时、错误信息

**3. 历史记录**

- 分页列表（可配置保留数量）
- 按时间/客户端/规则筛选
- 搜索请求内容
- 导出单个/批量请求

#### C. 预览与测试 (Preview & Test)

**1. 规则预览**

- 输入测试请求（或选择历史）
- 应用当前规则集
- 显示每一步修改过程
- 显示最终结果

**2. 沙盒测试**

- 独立测试环境
- 支持自定义请求体
- 逐条启用/禁用规则
- 实时查看效果变化

#### D. 数据管理 (Data Management)

**1. 配置持久化**

- 自动保存规则到JSON文件
- 支持多个配置文件切换
- 配置版本管理

**2. 数据导出/导入**

- 导出规则（JSON格式）
- 导出请求历史（JSON/CSV）
- 导入配置（合并/覆盖模式）

**3. 数据清理**

- 自动清理旧请求（保留最近N条）
- 手动清理历史
- 备份与恢复

### 非功能需求

#### 性能

- 支持1000+规则不卡顿
- 请求列表虚拟滚动
- 搜索响应 < 500ms
- 实时捕获不阻塞代理

#### 可用性

- 三断点响应式（移动端友好）
- 键盘快捷键
- 清晰的错误提示
- 操作可撤销

#### 可靠性

- 数据自动保存（防丢失）
- 异常恢复机制
- 请求捕获失败不影响代理

#### 安全性

- 本地运行，不暴露公网
- 敏感信息脱敏显示
- 数据导出加密选项

---

## 🎨 设计方案

### 设计灵感

#### 参考风格

1. **Postman** - API调试工具的经典布局
2. **Fiddler/Charles** - 代理工具的请求捕获
3. **VS Code** - 配置编辑的清晰层级

#### 设计原则

- **专业性**：开发者工具的严谨感
- **清晰度**：请求/响应/规则的三栏布局
- **实时性**：状态指示、实时更新
- **可操作性**：一键调试、快速切换

### 视觉系统

#### 色彩系统

```css
/* 主题色 - 专业开发者工具蓝 */
--primary: #007acc; /* VS Code蓝 */
--primary-hover: #0098ff;
--bg-main: #1e1e1e; /* 深色背景 */
--bg-panel: #252526; /* 面板背景 */
--bg-card: #2d2d30; /* 卡片背景 */
--border: #3e3e42; /* 边框色 */
--text-primary: #cccccc; /* 主文本 */
--text-secondary: #858585; /* 次要文本 */

/* 语义色 */
--success: #4ec9b0; /* 成功、启用 */
--warning: #ce9178; /* 警告、修改 */
--error: #f48771; /* 错误、禁用 */
--info: #569cd6; /* 信息、匹配 */

/* 差异高亮 */
--diff-added: #037a09; /* 新增 */
--diff-removed: #7a1921; /* 删除 */
--diff-modified: #6a4d00; /* 修改 */
```

#### 字体系统

```css
--font-mono: 'JetBrains Mono', 'Fira Code', monospace; /* 代码 */
--font-sans: 'Inter', system-ui, sans-serif; /* UI */
--font-size-xs: 12px;
--font-size-sm: 13px;
--font-size-base: 14px;
--font-size-lg: 16px;
--font-size-xl: 18px;
```

#### 间距系统

```css
--space-1: 4px;
--space-2: 8px;
--space-3: 12px;
--space-4: 16px;
--space-6: 24px;
--space-8: 32px;
```

### 页面布局

#### 主界面布局 (三栏式)

```
┌─────────────────────────────────────────────────────────────────┐
│ Header (48px)                                                   │
│ Logo │ 规则 │ 请求 │ 预览 │ 设置 │ 状态指示器                   │
├───────────┬──────────────────────┬──────────────────────────────┤
│ 左侧栏    │ 中间主区域           │ 右侧面板                    │
│ (280px)   │ (自适应)             │ (360px)                     │
│           │                      │                             │
│ 📋 规则   │ ┌──────────────────┐ │ ┌──────────────────────┐   │
│   列表    │ │ 规则/请求列表    │ │ │ 当前选中详情         │   │
│   搜索    │ │                  │ │ │                      │   │
│   筛选    │ │                  │ │ │                      │   │
│           │ └──────────────────┘ │ └──────────────────────┘   │
│           │                      │                             │
│ ➕ 新建   │ 分页/加载更多        │ 操作按钮                   │
│ 📊 统计   │                      │                            │
└───────────┴──────────────────────┴──────────────────────────────┘
```

#### 规则编辑器模态框

```
┌─────────────────────────────────────────────────────────────┐
│ 编辑规则 - rule-001                             [✕] [ESC]   │
├─────────────────────────────────────────────────────────────┤
│ 基本信息                                                    │
│ 规则ID: [rule-001________________]  [生成UUID]              │
│ 描述:   [添加自定义系统提示______________________________] │
│                                                             │
│ 匹配条件 (when)                                              │
│ 客户端: [○ claude] [● codex] [○ gemini]                    │
│ 字段:   [○ system] [● instructions]                        │
│ 方法:   [GET______________]  (可选)                        │
│ 路径正则:[^/v1/messages$____]  (可选)  [测试]              │
│ 模型正则:[claude-3_________]  (可选)  [测试]              │
│                                                             │
│ 操作序列 (ops)                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 1. [append]  文本: [\n\n## Custom Rules\n- Minimal] │ │
│ │    [↑] [↓] [删除] [复制]                              │ │
│ └────────────────────────────────────────────────────────┘ │
│ [➕ 添加操作]  [清空]                                      │
│                                                             │
│ 高级选项                                                    │
│ [ ] 在此规则后停止执行 (stop)                               │
│                                                             │
│ 预览与验证                                                  │
│ [▶ 测试规则]  [✓ 验证语法]  [⚠ 冲突检测]                  │
│                                                             │
│ 操作按钮                                                    │
│ [取消] [保存] [保存并关闭]                                  │
└─────────────────────────────────────────────────────────────┘
```

#### 请求详情视图

```
┌─────────────────────────────────────────────────────────────┐
│ 请求详情 - 2025-12-20 14:32:15                    [✕]      │
├─────────────────────────────────────────────────────────────┤
│ 基本信息                                                    │
│ 客户端: codex  |  路径: /v1/chat/completions               │
│ 状态: ✓ 成功  |  耗时: 234ms  |  规则匹配: 2条             │
│                                                             │
│ 原始请求体 (Original)                                       │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ {                                                      │ │
│ │   "model": "gpt-4",                                   │ │
│ │   "messages": [                                       │ │
│ │     {"role": "system", "content": "You are helpful"}  │ │
│ │   ]                                                   │ │
│ │ }                                                      │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                             │
│ 修改后请求体 (Modified)                                     │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ {                                                      │ │
│ │   "model": "gpt-4",                                   │ │
│ │   "messages": [                                       │ │
│ │     {"role": "system", "content": "You are helpful    │ │
│ │ \n\n## Custom Rules\n- Minimal"}                     │ │
│ │   ]                                                   │ │
│ │ }                                                      │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                             │
│ 差异对比 (Diff)                                             │
│ ┌────────────────────────────────────────────────────────┐ │
│ │   "content": "You are helpful                        │ │
│ │ + \n\n## Custom Rules\n- Minimal"}                   │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                             │
│ 匹配规则                                                    │
│ 1. rule-001 (append) - 匹配字段: instructions             │
│ 2. rule-002 (replace) - 匹配字段: system                  │
│                                                             │
│ 响应信息                                                    │
│ 状态码: 200  |  内容类型: application/json                │
│ [查看响应内容]  [重放请求]  [导出]                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 文件结构

```
promptxy/
├── index.html                    # 主入口
├── css/
│   ├── design-tokens.css         # 设计系统变量
│   ├── layout.css                # 布局系统
│   ├── components.css            # 组件样式
│   └── themes.css                # 主题（深色/浅色）
├── js/
│   ├── app.js                    # 应用入口
│   ├── storage.js                # 数据持久化（IndexedDB）
│   ├── rule-manager.js           # 规则CRUD
│   ├── request-capture.js        # 请求捕获与展示
│   ├── preview-engine.js         # 预览与测试引擎
│   ├── diff-viewer.js            # 差异对比
│   └── ui-components.js          # 可复用UI组件
├── assets/
│   ├── icons/                    # SVG图标
│   └── images/                   # 占位图（如需）
└── docs/
    └── WEB_UI_DESIGN.md          # 此文档
```

---

## 🔧 技术实现要点

### 后端API需求（基于确认）

**需要新增的后端端点：**

1. **SSE实时推送** - `GET /_promptxy/events`
   - 服务器发送事件（Server-Sent Events）
   - 推送内容：新请求捕获事件
   - 数据格式：`event: request\ndata: {请求详情JSON}\n\n`

2. **请求日志读取** - `GET /_promptxy/requests`
   - 查询参数：`?limit=50&offset=0&client=claude`
   - 返回：请求历史列表（最近100条）
   - 数据：原始请求、修改后请求、匹配规则、响应信息

3. **请求详情** - `GET /_promptxy/requests/:id`
   - 返回单个请求的完整详情

4. **配置同步** - `POST /_promptxy/config/sync`
   - 接收：更新后的规则数组
   - 行为：立即生效 + 写入配置文件
   - 返回：成功/失败状态

5. **配置读取** - `GET /_promptxy/config`
   - 返回当前规则配置

### 数据存储架构

**后端存储（SQLite）：**

```
~/.local/promptxy/
├── config.json              # 规则配置文件
├── promptxy.db              # SQLite数据库
│   ├── requests表
│   │   ├── id (TEXT PRIMARY KEY)
│   │   ├── timestamp (INTEGER)
│   │   ├── client (TEXT)
│   │   ├── path (TEXT)
│   │   ├── method (TEXT)
│   │   ├── original_body (TEXT) - JSON字符串
│   │   ├── modified_body (TEXT) - JSON字符串
│   │   ├── matched_rules (TEXT) - JSON数组
│   │   ├── response_status (INTEGER)
│   │   ├── duration_ms (INTEGER)
│   │   └── error (TEXT)
│   └── settings表
│       ├── key (TEXT PRIMARY KEY)
│       └── value (TEXT)
└── logs/
    ├── access.log           # 访问日志（运维用）
    └── error.log            # 错误日志
```

**前端存储（IndexedDB）：**

```
数据库: promptxy_ui
版本: 1

Store: ui_cache
- Key: 'last_sync'
- Key: 'theme'
- Key: 'view_preferences'

Store: offline_requests (缓存，可清空)
- Key: request_id
- Value: 完整请求数据（用于离线查看）
```

**数据同步策略：**

- 前端修改规则 → 立即POST到后端 → 后端保存到config.json + 内存生效
- 前端读取规则 → GET /config（始终从后端读取最新）
- 请求历史 → 后端SQLite是唯一真实数据源
- 前端缓存 → 仅用于加速显示，可随时清空

### 请求捕获与展示流程

**实时捕获（SSE）：**

```
后端代理逻辑：
1. 捕获原始请求 → 存入SQLite
2. 应用规则修改 → 记录修改详情
3. 转发请求 → 获取响应
4. 更新SQLite记录（响应信息）
5. 通过SSE推送事件到Web UI

Web UI：
1. 连接 SSE /_promptxy/events
2. 接收到新请求事件 → GET /_promptxy/requests/:id
3. 更新请求列表显示
4. 高亮新到达的请求
```

**历史查看：**

```
Web UI → GET /_promptxy/requests?limit=50&offset=0
后端 → 查询SQLite返回数据
Web UI → 渲染列表，点击查看详情
```

**差异对比：**

```
数据源：
- original_body: 原始请求JSON
- modified_body: 修改后请求JSON
- matched_rules: [{ruleId, opType}]

对比算法：
1. JSON解析
2. 深度优先遍历比较
3. 标记差异路径
4. 生成左右对比视图
```

### 配置同步机制

**即时生效流程：**

```
Web UI编辑规则 → 点击保存
↓
POST /_promptxy/config/sync
{
  rules: [...更新后的规则...]
}
↓
后端：
1. 验证规则格式
2. 更新内存中的rules数组（立即生效）
3. 写入config.json文件（持久化）
4. 返回成功响应
↓
Web UI：
1. 显示保存成功
2. 下一个请求立即使用新规则
```

**双向同步：**

```
启动时：
Web UI → GET /config
↓
检查本地是否有未同步的修改
↓
有冲突 → 提示用户选择版本
无冲突 → 使用后端配置
```

### 差异对比实现

**左右视图设计：**

```
┌─────────────────────────────────────────────────────────┐
│ 差异对比 - 请求ID: abc-123                              │
├──────────────────┬──────────────────┬──────────────────┤
│  原始请求        │  差异标记        │  修改后请求      │
│  (Original)      │  (Diff)          │  (Modified)      │
├──────────────────┼──────────────────┼──────────────────┤
│ {                │  {               │  {               │
│   "model":       │    "model":      │    "model":      │
│   "gpt-4",       │    "gpt-4",      │    "gpt-4",      │
│   "messages": [  │    "messages": [ │    "messages": [ │
│     {            │      {           │      {           │
│       "role":    │        "role":   │        "role":   │
│       "system",  │        "system", │        "system", │
│       "content": │        "content":│        "content":│
│       "You are"  │        "You are  │        "You are  │
│                    + \n\n## Custom  │ \n\n## Custom    │
│                    + Rules\n- Mini  │ Rules\n- Minimal│
│     }            │      }           │      }           │
│   ]              │    ]             │    ]             │
│ }                │  }               │  }               │
│                  │                  │                  │
│                  │  匹配规则:       │                  │
│                  │  1. rule-001     │                  │
│                  │     (append)     │                  │
│                  │  2. rule-002     │                  │
│                  │     (replace)    │                  │
└──────────────────┴──────────────────┴──────────────────┘
```

**差异算法：**

```javascript
function generateDiff(original, modified) {
  // 1. 解析JSON
  const origObj = JSON.parse(original);
  const modObj = JSON.parse(modified);

  // 2. 深度比较
  const diff = deepDiff(origObj, modObj);

  // 3. 生成行级对比
  return {
    left: formatJSON(origObj, diff, 'removed'),
    right: formatJSON(modObj, diff, 'added'),
    markers: diff.markers,
  };
}
```

### 数据保留策略

**自动清理：**

```
后端定时任务：
- 每小时检查一次
- 保留最近100条请求
- 删除旧数据（SQLite DELETE）
- 记录清理日志

Web UI：
- 显示当前存储数量
- 提供手动清理按钮
- 警告存储空间不足
```

**导出/导入：**

```
导出：
- 规则配置 → JSON文件
- 请求历史 → JSON/CSV文件
- 包含完整数据（原始+修改+响应）

导入：
- 规则配置 → 合并/覆盖模式
- 请求历史 → 仅用于查看，不覆盖当前数据
```

### 规则编辑器

**动态表单逻辑：**

```javascript
const opTypeFields = {
  set: ['text'],
  append: ['text'],
  prepend: ['text'],
  replace: ['match', 'regex', 'flags', 'replacement'],
  delete: ['match', 'regex', 'flags'],
  insert_before: ['regex', 'flags', 'text'],
  insert_after: ['regex', 'flags', 'text'],
};
```

### 差异对比算法

**简单行级对比：**

```javascript
function diffLines(original, modified) {
  const origLines = original.split('\n');
  const modLines = modified.split('\n');

  // 使用最长公共子序列(LCS)算法
  // 标记: unchanged / added / removed / modified
}
```

**JSON路径对比：**

```javascript
// 识别具体修改的JSON路径
// 例如: messages[0].content → 添加了文本
```

---

## 🚀 开发优先级

### Phase 1: MVP (1周)

- ✅ 规则列表展示与编辑
- ✅ 基础请求捕获与查看
- ✅ 本地存储（IndexedDB）
- ✅ 简单预览功能

**验收标准：**

- 可以创建/编辑/删除规则
- 能看到经过代理的请求
- 数据刷新不丢失

### Phase 2: 增强 (1周)

- ✅ 差异对比可视化
- ✅ 请求筛选与搜索
- ✅ 规则测试沙盒
- ✅ 导出/导入功能

**验收标准：**

- 清晰看到修改前后差异
- 快速找到历史请求
- 可以离线测试规则

### Phase 3: 优化 (1周)

- ✅ 实时推送（SSE）
- ✅ 性能优化（虚拟滚动）
- ✅ 键盘快捷键
- ✅ 响应式适配

**验收标准：**

- 1000+请求流畅
- 移动端可用
- 键盘操作高效

---

## 📊 数据流程图

```
用户操作流程：
┌─────────────┐
│ 1. 启动Web UI │
└──────┬──────┘
       │
       ↓
┌──────────────────────────────┐
│ 2. 查看/编辑规则              │
│    - 从IndexedDB加载          │
│    - 修改后自动保存           │
└──────┬───────────────────────┘
       │
       ↓
┌──────────────────────────────┐
│ 3. 启动PromptXY代理           │
│    - 监听7070端口             │
│    - 捕获请求并写入日志       │
└──────┬───────────────────────┘
       │
       ↓
┌──────────────────────────────┐
│ 4. CLI发起请求                │
│    - 经过代理                 │
│    - 规则应用                 │
└──────┬───────────────────────┘
       │
       ↓
┌──────────────────────────────┐
│ 5. Web UI读取日志             │
│    - SSE实时更新              │
│    - 显示请求列表             │
└──────┬───────────────────────┘
       │
       ↓
┌──────────────────────────────┐
│ 6. 查看请求详情               │
│    - 原始 vs 修改对比         │
│    - 匹配规则列表             │
└──────────────────────────────┘
```

---

## 🎯 核心用户故事

### 故事1：调试规则

```
作为：开发者
想要：知道为什么某个请求被修改了
步骤：
  1. 在CLI中发起请求
  2. 在Web UI看到新请求记录
  3. 点击查看详情
  4. 看到原始请求和修改后请求
  5. 看到匹配的规则列表
  6. 理解修改原因
```

### 故事2：创建新规则

```
作为：开发者
想要：添加一条新规则
步骤：
  1. 点击"新建规则"
  2. 填写匹配条件（client/field）
  3. 选择操作类型（append）
  4. 填写操作参数（文本内容）
  5. 点击"测试"预览效果
  6. 保存规则
  7. CLI发起请求验证
  8. 在Web UI确认规则生效
```

### 故事3：分析历史请求

```
作为：开发者
想要：找出某个问题的原因
步骤：
  1. 搜索历史请求
  2. 筛选特定客户端
  3. 查看请求详情
  4. 对比原始和修改后
  5. 识别问题规则
  6. 编辑或禁用规则
  7. 重放请求验证
```

---

## 🔍 技术挑战与解决方案

### 挑战1：实时性

**问题**：如何实时显示新请求？
**方案**：SSE + 日志文件轮询

- 后端写入JSONL日志
- Web UI通过EventSource读取
- 增量更新UI

### 挑战2：性能

**问题**：大量请求/规则导致卡顿？
**方案**：

- 虚拟滚动（只渲染可见项）
- 分页加载（每次50条）
- Web Workers处理diff计算
- IndexedDB索引优化

### 挑战3：数据同步

**问题**：Web UI和后端配置如何同步？
**方案**：

- 规则修改时同时保存到：
  1. IndexedDB（Web UI）
  2. JSON文件（后端配置）
- 启动时双向同步
- 冲突时提示用户

### 挑战4：差异展示

**问题**：如何清晰展示JSON修改？
**方案**：

- JSON格式化+语法高亮
- 行级diff（+/-标记）
- 路径高亮（messages[0].content）
- 折叠/展开复杂结构

---

## 📝 实现清单

### HTML结构

- [ ] 主容器（三栏布局）
- [ ] 规则列表页
- [ ] 规则编辑器模态框
- [ ] 请求列表页
- [ ] 请求详情模态框
- [ ] 预览/测试页面
- [ ] 设置页面

### CSS样式

- [ ] 设计系统变量
- [ ] 布局系统（Grid/Flex）
- [ ] 组件样式（按钮、卡片、表单）
- [ ] 主题切换（深色/浅色）
- [ ] 响应式断点
- [ ] 动效过渡

### JavaScript功能

- [ ] IndexedDB封装
- [ ] 规则CRUD操作
- [ ] 请求捕获与展示
- [ ] 差异对比算法
- [ ] 预览引擎
- [ ] SSE客户端
- [ ] 搜索筛选
- [ ] 导出导入
- [ ] 键盘快捷键

---

## ✅ 下一步行动

1. **确认设计**：请Review此文档，确认理解正确
2. **开始实现**：按照Phase 1优先级开发
3. **迭代优化**：根据使用反馈调整

**关键问题需要确认：**

- 后端是否需要提供新的API端点？（如日志读取、配置同步）
- 是否需要WebSocket还是SSE足够？
- 请求历史保留数量上限？
- 是否需要支持多配置文件切换？

---

**文档版本**: v1.0
**创建日期**: 2025-12-20
**状态**: 待评审
