# PromptXY åè®®è½¬æ¢åŠŸèƒ½è°ƒç ”æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1
**åˆ›å»ºæ—¥æœŸ**: 2025-01-01
**æœ€åæ›´æ–°**: 2026-01-01
**è°ƒç ”äººå‘˜**: Claude AIï¼ˆåˆç¨¿ï¼‰/ PromptXY å›¢é˜Ÿï¼ˆä¿®è®¢ï¼‰
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è°ƒç ” / æŠ€æœ¯æ–¹æ¡ˆï¼ˆé¢å‘å®ç°ï¼‰
**åç»­çŠ¶æ€**: å¾… Reviewï¼ˆç¡®è®¤åè¿›å…¥ææ¡ˆ/å®ç°ï¼‰

---

## ç›®å½•

1. [è°ƒç ”èƒŒæ™¯ä¸ç›®æ ‡](#1-è°ƒç ”èƒŒæ™¯ä¸ç›®æ ‡)
2. [å½“å‰é¡¹ç›®ç°çŠ¶åˆ†æ](#2-å½“å‰é¡¹ç›®ç°çŠ¶åˆ†æ)
3. [å‚è€ƒé¡¹ç›®ç ”ç©¶](#3-å‚è€ƒé¡¹ç›®ç ”ç©¶)
4. [æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡](#4-æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡)
5. [å¯è§†åŒ–ç•Œé¢è®¾è®¡](#5-å¯è§†åŒ–ç•Œé¢è®¾è®¡)
6. [å®æ–½è®¡åˆ’](#6-å®æ–½è®¡åˆ’)
7. [é£é™©è¯„ä¼°ä¸ç¼“è§£](#7-é£é™©è¯„ä¼°ä¸ç¼“è§£)
8. [é™„å½•](#8-é™„å½•)

---

## 1. è°ƒç ”èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èƒŒæ™¯æè¿°

PromptXY é¡¹ç›®å½“å‰æ˜¯ä¸€ä¸ªæœ¬åœ° HTTP ç½‘å…³ï¼Œæ”¯æŒå¯¹ Claude Codeã€Codex CLIã€Gemini CLI ç­‰å®¢æˆ·ç«¯çš„è¯·æ±‚è¿›è¡Œå†…å®¹ä¿®æ”¹ï¼ˆå¦‚æç¤ºè¯æ”¹å†™ï¼‰ã€‚é¡¹ç›®å·²å…·å¤‡ï¼š

- å¤šä¾›åº”å•†è¯·æ±‚è½¬å‘èƒ½åŠ›
- è§„åˆ™å¼•æ“ï¼ˆPromptXY Rulesï¼‰ç”¨äºå†…å®¹ä¿®æ”¹
- å¯è§†åŒ–é…ç½®ç•Œé¢
- è¯·æ±‚å†å²è®°å½•ä¸é¢„è§ˆ

### 1.2 éœ€æ±‚æ¥æº

ç”¨æˆ·å¸Œæœ›ä¸ºé¡¹ç›®æ·»åŠ **åè®®è½¬æ¢åŠŸèƒ½**ï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

1. **ç»Ÿä¸€å…¥å£**: æ¥æ”¶ Claude Code å‘é€çš„ç¬¦åˆ Anthropic åè®®çš„è¯·æ±‚
2. **åè®®è½¬æ¢**: å°† Anthropic åè®®è½¬æ¢ä¸ºä¸åŒä¾›åº”å•†çš„åè®®æ ¼å¼
3. **è§£è€¦è®¾è®¡**: æ–¹ä¾¿å¯¹æ¥æ–°çš„ä¾›åº”å•†ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
4. **å¯è§†åŒ–å±•ç¤º**: é€šè¿‡ç”»å¸ƒå½¢å¼å±•ç¤ºåè®®è½¬æ¢å‰åçš„æ˜ å°„å…³ç³»

### 1.3 è°ƒç ”ç›®æ ‡

1. ç ”ç©¶å‚è€ƒé¡¹ç›® `claude-code-router` çš„åè®®è½¬æ¢å®ç°
2. åˆ†æ Anthropic åè®®ä¸ä¸»æµä¾›åº”å•†åè®®çš„å·®å¼‚
3. è®¾è®¡è§£è€¦çš„åè®®è½¬æ¢æ¶æ„
4. è®¾è®¡â€œå¯éªŒè¯/é¢„è§ˆ/traceâ€ä¸ºä¸»çš„å¯è§†åŒ–æ–¹æ¡ˆï¼ˆç”»å¸ƒæ˜ å°„ä½œä¸º v2+ å¯é€‰å¢å¼ºï¼‰
5. è¯„ä¼°æŠ€æœ¯é€‰å‹ä¸å®æ–½é£é™©

### 1.4 èŒƒå›´ä¸çº¦æŸï¼ˆv1 æ˜ç¡®è¾¹ç•Œï¼‰

ä¸ºé¿å…â€œå…ˆåšå¤æ‚è·¯ç”±/ç¼–æ’å¯¼è‡´é¡¹ç›®å¤±ç„¦â€ï¼Œæœ¬æœŸåè®®è½¬æ¢ï¼ˆv1ï¼‰æ˜ç¡®å¦‚ä¸‹è¾¹ç•Œï¼š

- **å•ä¸€ localPrefix â‡„ å•ä¸€ Supplierï¼ˆä¿æŒç°çŠ¶ï¼‰**  
  `localPrefix` è¡¨è¾¾çš„æ˜¯ PromptXY å¯¹ AI å·¥å…·æš´éœ²çš„ç½‘å…³è·¯å¾„å‰ç¼€ã€‚å½“å‰å®ç°å·²å¼ºåˆ¶æ ¡éªŒï¼šåŒä¸€ä¸ª `localPrefix` ä¸èƒ½è¢«å¤šä¸ª *enabled* supplier åŒæ—¶ä½¿ç”¨ï¼ˆè§ `backend/src/promptxy/config.ts` çš„æ ¡éªŒé€»è¾‘ï¼‰ã€‚
- **ä¸å¼•å…¥ Router / ä¸åšå¤šä¾›åº”å•†é€‰æ‹©ç­–ç•¥**  
  æœ¬æœŸåªå®ç°â€œåè®®è½¬æ¢å±‚â€èƒ½åŠ›ï¼›è·¯ç”±ç­–ç•¥ï¼ˆæŒ‰ä»»åŠ¡åœºæ™¯/æ¨¡å‹/è„šæœ¬ï¼‰å±äºåç»­æ‰©å±•ã€‚
  - v1 çš„â€œç»Ÿä¸€å…¥å£â€æŒ‡ï¼šPromptXY å¯¹ä¸‹æ¸¸æš´éœ² **Claude Code/Anthropic åè®®å…¼å®¹** çš„ç»Ÿä¸€å…¥å£ï¼›åœ¨å‘½ä¸­ `localPrefix` åï¼Œä»…è½¬æ¢å¹¶è½¬å‘åˆ°è¯¥ supplierï¼ˆå•ä¸Šæ¸¸ï¼‰ï¼Œä¸åšå¤šä¸Šæ¸¸é€‰æ‹©ã€‚
- **æ¨¡å‹åŒ¹é…åªåšç²¾ç¡®åŒ¹é…ï¼ˆexact matchï¼‰**  
  `transformer.models` çš„ key ä»…æ”¯æŒç²¾ç¡®åŒ¹é… model å­—ç¬¦ä¸²ï¼›ä¸æ”¯æŒ regex/é€šé…ï¼Œä¾¿äºéªŒè¯ä¸ UI ç¼–è¾‘ã€‚
- **é…ç½®ä¸ç›´æ¥å¤ç”¨ `@musistudio/llms` é…ç½®**  
  PromptXY å®šä¹‰è‡ªå·±çš„é…ç½®ç»“æ„ï¼›è¿è¡Œæ—¶é€šè¿‡â€œå…¼å®¹å±‚â€ç¼–è¯‘/é€‚é…åˆ° `@musistudio/llms` çš„è°ƒç”¨æ–¹å¼ã€‚
- **PromptXY éœ€è¦å­˜å‚¨ä¾›åº”å•†å¯†é’¥ï¼ˆtoken/keyï¼‰**  
  åŸæœ‰â€œå®Œå…¨é€ä¼ è®¤è¯å¤´ã€ä¸å­˜å‚¨å¯†é’¥â€çš„æ¨¡å¼å°†ä¸å†æ»¡è¶³â€œç»Ÿä¸€å…¥å£ + åè®®è½¬æ¢â€çš„ç›®æ ‡ã€‚v1 æ–¹å‘æ˜¯ï¼šPromptXY å¯¹å†…æä¾›ç»Ÿä¸€çš„ URL ä¸ tokenï¼ŒæŒ‰ supplier æ³¨å…¥ä¸Šæ¸¸è®¤è¯ä¿¡æ¯ï¼ˆç±»ä¼¼ claude-code-router çš„ä½¿ç”¨ä½“éªŒï¼‰ã€‚
  - å¤‡æ³¨ï¼šè¿™ä¼šä¸ç°æœ‰ç”¨æˆ·æ–‡æ¡£ä¸­â€œpromptxy ä¸å­˜å‚¨å¯†é’¥â€çš„è¡¨è¿°äº§ç”Ÿå†²çªï¼Œè¿›å…¥å®ç°é˜¶æ®µæ—¶éœ€è¦åŒæ­¥æ›´æ–°ç›¸å…³æ–‡æ¡£ä¸ UI æç¤ºã€‚

---

## 2. å½“å‰é¡¹ç›®ç°çŠ¶åˆ†æ

### 2.1 é¡¹ç›®ç»“æ„

```
promptxy/
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ src/promptxy/
â”‚       â”œâ”€â”€ adapters/           # ç°æœ‰ï¼šå®¢æˆ·ç«¯é€‚é…å™¨
â”‚       â”‚   â”œâ”€â”€ claude.ts       # Claude å†…å®¹é€‚é…
â”‚       â”‚   â”œâ”€â”€ codex.ts        # Codex å†…å®¹é€‚é…
â”‚       â”‚   â””â”€â”€ gemini.ts       # Gemini å†…å®¹é€‚é…
â”‚       â”œâ”€â”€ gateway.ts          # ç½‘å…³æ ¸å¿ƒ
â”‚       â”œâ”€â”€ rules/              # è§„åˆ™å¼•æ“
â”‚       â”œâ”€â”€ types.ts            # ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ ...
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ request-viewer/ # è¯·æ±‚æŸ¥çœ‹å™¨
â”‚       â”‚   â”œâ”€â”€ rules/          # è§„åˆ™ç®¡ç†
â”‚       â”‚   â””â”€â”€ suppliers/      # ä¾›åº”å•†ç®¡ç†
â”‚       â””â”€â”€ ...
â””â”€â”€ docs/
```

### 2.2 ç°æœ‰èƒ½åŠ›

#### 2.2.1 é€‚é…å™¨ï¼ˆAdaptersï¼‰

å½“å‰ `adapters/` ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸»è¦ç”¨äº**å†…å®¹ä¿®æ”¹**ï¼Œè€Œé**åè®®è½¬æ¢**ï¼š

```typescript
// adapters/claude.ts - ä»…ä¿®æ”¹ system å­—æ®µå†…å®¹
export function mutateClaudeBody(options: {
  body: any;
  method: string;
  path: string;
  rules: PromptxyRule[];
}): { body: any; matches: PromptxyRuleMatch[] }
```

**å…³é”®å‘ç°**: ç°æœ‰é€‚é…å™¨åªä¿®æ”¹è¯·æ±‚ä½“ä¸­çš„å­—æ®µå€¼ï¼ˆå¦‚ `system` æç¤ºè¯ï¼‰ï¼Œä¸å¤„ç†åè®®æ ¼å¼è½¬æ¢ã€‚

#### 2.2.2 ä¾›åº”å•†ï¼ˆSuppliersï¼‰

```typescript
// types.ts - å½“å‰ Supplier é…ç½®
export interface Supplier {
  id: string;
  name: string;
  baseUrl: string;              // ä¸Šæ¸¸åœ°å€
  localPrefix: string;          // æœ¬åœ°è·¯å¾„å‰ç¼€ï¼ˆå¦‚ /claudeï¼‰
  pathMappings?: PathMapping[]; // è·¯å¾„æ˜ å°„
  enabled: boolean;
}
```

**å…³é”®å‘ç°**:
- å·²æœ‰ Supplier æ¦‚å¿µã€è·¯å¾„æ˜ å°„æ¦‚å¿µã€ä»¥åŠæœ¬åœ°å‰ç¼€ï¼ˆlocalPrefixï¼‰æ¦‚å¿µã€‚
- å½“å‰ supplier é…ç½® **ä¸åŒ…å«å¯†é’¥**ï¼ˆtoken/keyï¼‰ä¸åè®®è½¬æ¢é…ç½®ï¼ˆtransformerï¼‰ã€‚

#### 2.2.3 ç½‘å…³æµç¨‹

å½“å‰ç½‘å…³ï¼ˆ`backend/src/promptxy/gateway.ts`ï¼‰çš„å®é™…è¡Œä¸ºå¯å½’çº³ä¸ºï¼š

1. **API ä¸é™æ€èµ„æºä¼˜å…ˆå¤„ç†**ï¼š`/_promptxy/*` ä¸å‰ç«¯é™æ€èµ„æºåœ¨ä»£ç†ä¹‹å‰å¤„ç†ã€‚
2. **æŒ‰è·¯å¾„æŸ¥æ‰¾ä¾›åº”å•†**ï¼šåœ¨ *enabled suppliers* ä¸­æŒ‰ `localPrefix` **é•¿åº¦å€’åº**åŒ¹é…ï¼ˆæ›´é•¿çš„å‰ç¼€ä¼˜å…ˆï¼‰ã€‚
3. **æ¨æ–­ client ç±»å‹**ï¼ˆç°å®ç°ï¼‰ï¼š  
   - å‰ç¼€ä»¥ `/openai` å¼€å¤´ â†’ `codex`  
   - å‰ç¼€ä»¥ `/gemini` å¼€å¤´ â†’ `gemini`  
   - å…¶ä»– â†’ `claude`
4. **æ„é€ ä¸Šæ¸¸ URL**ï¼š  
   - `upstreamPath = stripPrefix(url.pathname, localPrefix)`  
   - `upstreamPath = applyPathMappings(upstreamPath, supplier.pathMappings)`  
   - `upstreamUrl = joinUrl(supplier.baseUrl, upstreamPath, url.search)`
5. **è¯»å–å¹¶è§£æè¯·æ±‚ä½“ï¼ˆå¦‚æœæ˜¯ JSONï¼‰**ï¼š`Content-Type` çœ‹èµ·æ¥æ˜¯ JSON æ‰å°è¯• parseï¼›parse å¤±è´¥ä¿æŒé€ä¼ ã€‚
6. **åº”ç”¨å†…å®¹ä¿®æ”¹ï¼ˆrulesï¼‰**ï¼šæŒ‰ client è°ƒç”¨ `mutateClaudeBody / mutateCodexBody / mutateGeminiBody`ã€‚
7. **è½¬å‘åˆ°ä¸Šæ¸¸**ï¼š`fetch(upstreamUrl)`ï¼Œå¹¶æŠŠä¸Šæ¸¸å“åº” **æµå¼ pipe** ç»™å®¢æˆ·ç«¯ï¼›åŒæ—¶æ”¶é›†å“åº”ç‰‡æ®µç”¨äºå†å²è®°å½•ã€‚

**å…³é”®ç»“è®ºï¼ˆå¯¹æœ¬æ–¹æ¡ˆå½±å“å¾ˆå¤§ï¼‰**ï¼š
- ç½‘å…³å½“å‰æ˜¯â€œè¾¹è½¬å‘è¾¹è®°å½•â€çš„æµå¼ç®¡é“æ¨¡å‹ï¼›å¼•å…¥â€œåè®®è½¬æ¢ï¼ˆå°¤å…¶æ˜¯ SSEï¼‰â€åï¼Œå“åº”ä¾§å¾ˆå¯èƒ½éœ€è¦ä»â€œç›´æ¥ pipeâ€å‡çº§ä¸ºâ€œè¾¹è§£æè¾¹é‡å†™å†è¾“å‡ºâ€ã€‚
- ç°æœ‰æµç¨‹ä¸­ï¼Œåè®®è½¬æ¢å±‚æœ€è‡ªç„¶çš„æ’å…¥ç‚¹åœ¨ **rulesï¼ˆå†…å®¹ä¿®æ”¹ï¼‰ä¹‹åã€fetch ä¹‹å‰**ã€‚

### 2.3 ç°æœ‰å±€é™æ€§

| å±€é™ç‚¹ | æè¿° |
|--------|------|
| **åè®®æ ¼å¼å›ºå®š** | å‡è®¾ä¸Šæ¸¸ä½¿ç”¨ä¸å®¢æˆ·ç«¯ç›¸åŒçš„åè®®æ ¼å¼ |
| **å­—æ®µç»“æ„å·®å¼‚** | æ— æ³•å¤„ç† toolsã€streaming ç­‰æ ¼å¼å·®å¼‚ |
| **æ— è½¬æ¢è¿½è¸ª** | ç¼ºå°‘åè®®è½¬æ¢è¿‡ç¨‹çš„å¯è§†åŒ–å±•ç¤º |
| **æ‰©å±•æ€§** | æ·»åŠ æ–°ä¾›åº”å•†éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç  |
| **è®¤è¯æ¨¡å¼å—é™** | å½“å‰å¼ºè°ƒâ€œä»…é€ä¼ è®¤è¯å¤´ã€ä¸å­˜å‚¨å¯†é’¥â€ï¼Œéš¾ä»¥æä¾›â€œç»Ÿä¸€å…¥å£ + åè®®è½¬æ¢ï¼ˆè½¬å‘åˆ°ä¸Šæ¸¸ï¼‰â€çš„ä½“éªŒ |

---

## 3. å‚è€ƒé¡¹ç›®ç ”ç©¶

### 3.1 é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: claude-code-router
**GitHub**: https://github.com/musistudio/claude-code-router
**æ ¸å¿ƒåŠŸèƒ½**: å°† Claude Code è¯·æ±‚è·¯ç”±åˆ°ä¸åŒ LLM ä¾›åº”å•†
**å…³é”®ä¾èµ–**: `@musistudio/llms` (åè®®è½¬æ¢æ ¸å¿ƒåº“)

### 3.2 æ¶æ„åˆ†æ

#### 3.2.1 æ•´ä½“æ¶æ„

```
Claude Code
    â†“ (Anthropic åè®®)
claude-code-router
    â†“ (ä½¿ç”¨ @musistudio/llms è½¬æ¢)
ä¸åŒä¾›åº”å•† API
```

#### 3.2.2 æ ¸å¿ƒç»„ä»¶

**1. Transformer ç³»ç»Ÿ**

```typescript
// é…ç½®ç¤ºä¾‹
{
  "Providers": [
    {
      "name": "deepseek",
      "api_base_url": "https://api.deepseek.com/chat/completions",
      "api_key": "sk-xxx",
      "models": ["deepseek-chat", "deepseek-reasoner"],
      "transformer": {
        "use": ["deepseek"],                    // å…¨å±€è½¬æ¢å™¨
        "deepseek-chat": {
          "use": ["tooluse"]                    // æ¨¡å‹ç‰¹å®šè½¬æ¢å™¨
        }
      }
    }
  ]
}
```

**ç‰¹ç‚¹**:
- æ”¯æŒé“¾å¼è½¬æ¢å™¨ç»„åˆ
- å¯ä¸ºä¸åŒæ¨¡å‹é…ç½®ä¸åŒè½¬æ¢å™¨
- æ”¯æŒä¼ é€’é€‰é¡¹ç»™è½¬æ¢å™¨

**2. è·¯ç”±ç³»ç»Ÿ**

```typescript
// Router é…ç½®
{
  "Router": {
    "default": "deepseek,deepseek-chat",        // é»˜è®¤æ¨¡å‹
    "background": "ollama,qwen2.5-coder:latest", // åå°ä»»åŠ¡
    "think": "deepseek,deepseek-reasoner",       // æ€è€ƒä»»åŠ¡
    "longContext": "openrouter,gemini-2.5-pro",  // é•¿ä¸Šä¸‹æ–‡
    "longContextThreshold": 60000,               // è§¦å‘é˜ˆå€¼
    "webSearch": "gemini,gemini-2.5-flash"       // ç½‘ç»œæœç´¢
  }
}
```

**ç‰¹ç‚¹**:
- åŸºäºåœºæ™¯çš„æ¨¡å‹è·¯ç”±
- æ”¯æŒåŠ¨æ€æ¨¡å‹åˆ‡æ¢ï¼ˆé€šè¿‡ `/model` å‘½ä»¤ï¼‰
- æ”¯æŒè‡ªå®šä¹‰è·¯ç”±è„šæœ¬

**3. Agent ç³»ç»Ÿ**

```typescript
// agents/type.ts
export interface IAgent {
  name: string;
  tools: Map<string, ITool>;
  shouldHandle: (req: any, config: any) => boolean;
  reqHandler: (req: any, config: any) => void;
  resHandler?: (payload: any, config: any) => void;
}
```

**ç‰¹ç‚¹**:
- ç”¨äºå¤„ç†ç‰¹æ®Šè¯·æ±‚ï¼ˆå¦‚å›¾åƒï¼‰
- å¯æ³¨å…¥è‡ªå®šä¹‰å·¥å…·
- æ”¯æŒè¯·æ±‚/å“åº”æ‹¦æˆª

#### 3.2.3 SSE æµå¤„ç†

```typescript
// utils/SSEParser.transform.ts
export class SSEParserTransform extends TransformStream<string, any> {
  // è§£æ SSE äº‹ä»¶æµ
  // æ”¯æŒ event:ã€data:ã€id:ã€retry: å­—æ®µ
}

// utils/SSESerializer.transform.ts
export class SSESerializerTransform extends TransformStream<any, string> {
  // åºåˆ—åŒ–ä¸º SSE æ ¼å¼
}
```

**å…³é”®å‘ç°**: å®Œæ•´çš„ SSE åŒå‘è½¬æ¢èƒ½åŠ›ã€‚

### 3.3 æ”¯æŒçš„ä¾›åº”å•†

| ä¾›åº”å•† | Transformer | æ”¯æŒçŠ¶æ€ |
|--------|-------------|----------|
| DeepSeek | `deepseek` | âœ… å®Œæ•´æ”¯æŒ |
| Gemini | `gemini` | âœ… å®Œæ•´æ”¯æŒ |
| Gemini CLI | `gemini-cli` | âœ… å®éªŒæ€§æ”¯æŒ |
| OpenRouter | `openrouter` | âœ… å®Œæ•´æ”¯æŒ |
| Ollama | é»˜è®¤ï¼ˆOpenAI æ ¼å¼ï¼‰ | âœ… å®Œæ•´æ”¯æŒ |
| Volcengine | `deepseek` | âœ… å®Œæ•´æ”¯æŒ |
| Groq | `groq` | âœ… å®Œæ•´æ”¯æŒ |
| Azure OpenAI | å†…ç½® | âœ… åŸç”Ÿæ”¯æŒ |
| è‡ªå®šä¹‰ API | è‡ªå®šä¹‰ transformer | âœ… å¯æ‰©å±• |

### 3.4 æ ¸å¿ƒä¾èµ–ï¼š@musistudio/llms

#### 3.4.1 åŸºæœ¬ä¿¡æ¯

- **åŒ…å**: `@musistudio/llms`
- **ç‰ˆæœ¬è®°å½•ï¼ˆè°ƒç ”æ—¶ç‚¹ï¼‰**: æˆªè‡³ 2025-12-18 å·²å‘å¸ƒ 1.0.51
- **ä»“åº“**: https://github.com/musistudio/llms
- **æè¿°**: A universal LLM API transformation server
- **è®¸å¯è¯**: MIT

#### 3.4.2 èƒ½åŠ›åˆ†æ

**æ ¸å¿ƒåŠŸèƒ½**:
1. ç»Ÿä¸€çš„ LLM API æ¥å£
2. ä¾›åº”å•†åè®®è½¬æ¢
3. Transformer æ³¨å†Œä¸ç»„åˆ
4. Fastify é›†æˆï¼ˆhooks å’Œä¸­é—´ä»¶ï¼‰
5. SSE æµå¼å“åº”è½¬æ¢

**Transformer åˆ—è¡¨**:

| Transformer | åŠŸèƒ½ |
|-------------|------|
| `anthropic` | Anthropic åŸå§‹åè®®ï¼ˆé€ä¼ ï¼‰ |
| `deepseek` | DeepSeek API æ ¼å¼è½¬æ¢ |
| `gemini` | Gemini API æ ¼å¼è½¬æ¢ |
| `gemini-cli` | Gemini CLI ç‰¹æ®Šæ ¼å¼ |
| `openrouter` | OpenRouter APIï¼ˆå« provider è·¯ç”±ï¼‰ |
| `groq` | Groq API æ ¼å¼è½¬æ¢ |
| `maxtoken` | è®¾ç½® max_tokens å€¼ |
| `tooluse` | ä¼˜åŒ–å·¥å…·è°ƒç”¨ |
| `reasoning` | å¤„ç†æ¨ç†å†…å®¹ |
| `sampling` | å¤„ç†é‡‡æ ·å‚æ•° |
| `enhancetool` | å·¥å…·è°ƒç”¨é”™è¯¯å®¹å¿ |
| `cleancache` | æ¸…é™¤ cache_control å­—æ®µ |
| `vertex-gemini` | Vertex AI Gemini |
| `chutes-glm` | GLM 4.5 æ”¯æŒ |
| `qwen-cli` | Qwen CLI æ”¯æŒ |
| `rovo-cli` | Rovo Dev CLI æ”¯æŒ |

**å…³é”®å‘ç°**:
- âœ… **è¦†ç›–å…¨é¢**: æ”¯æŒ DeepSeekã€Geminiã€OpenRouter ç­‰ä¸»æµä¾›åº”å•†
- âœ… **æ´»è·ƒç»´æŠ¤**: æˆªè‡³ 2025-12 ä»æœ‰ç‰ˆæœ¬å‘å¸ƒ
- âœ… **å¯æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰ Transformer
- âœ… **SSE æ”¯æŒ**: å®Œæ•´çš„æµå¼å“åº”è½¬æ¢

---

## 4. æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 4.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PromptXY é¡¹ç›®æ¶æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    å‰ç«¯å¯è§†åŒ–å±‚ (React + Tailwind)               â”‚    â”‚
â”‚  â”‚  â€¢ ä¾›åº”å•†é…ç½®ç®¡ç†    â€¢ åè®®é¢„è§ˆ    â€¢ è½¬æ¢æ—¥å¿—å±•ç¤º                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              PromptXY ç½‘å…³ (Node.js + TypeScript)                â”‚    â”‚
â”‚  â”‚  â€¢ è§„åˆ™å¼•æ“        â€¢ è¯·æ±‚è®°å½•    â€¢ è·¯å¾„æ˜ å°„                       â”‚    â”‚
â”‚  â”‚  â€¢ æ–°å¢: åè®®è½¬æ¢ç¼–æ’    â€¢ Transformer é…ç½® / Supplier Auth æ³¨å…¥   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          åè®®è½¬æ¢å±‚ï¼ˆPromptXY é…ç½® + llms å…¼å®¹å±‚ï¼‰               â”‚    â”‚
â”‚  â”‚  â€¢ Anthropic â†’ OpenAI (DeepSeek, Groq, etc.)                   â”‚    â”‚
â”‚  â”‚  â€¢ Anthropic â†’ Gemini                                          â”‚    â”‚
â”‚  â”‚  â€¢ Anthropic â†’ è‡ªå®šä¹‰ (æ‰©å±• Transformer)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      ä¸Šæ¸¸ä¾›åº”å•† API                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç›®å½•ç»“æ„è®¾è®¡

```
backend/src/promptxy/
â”œâ”€â”€ transformers/                 # æ–°å¢: åè®®è½¬æ¢æ¨¡å—
â”‚   â”œâ”€â”€ index.ts                 # å¯¼å‡ºå…¥å£
â”‚   â”œâ”€â”€ llms-compat.ts           # @musistudio/llms å…¼å®¹/é€‚é…å±‚ï¼ˆç¼–è¯‘ PromptXY é…ç½®ï¼‰
â”‚   â”œâ”€â”€ registry.ts              # è½¬æ¢å™¨æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ types.ts                 # è½¬æ¢å™¨ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ anthropic/               # Anthropic åè®®ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ types.ts             # Anthropic ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ parser.ts            # è¯·æ±‚/å“åº”è§£æ
â”‚   â”‚   â””â”€â”€ validator.ts         # åè®®éªŒè¯
â”‚   â”œâ”€â”€ openai/                  # OpenAI å…¼å®¹åè®®
â”‚   â”‚   â”œâ”€â”€ transformer.ts       # OpenAI è½¬æ¢å™¨åŒ…è£…
â”‚   â”‚   â”œâ”€â”€ sse.ts               # SSE æµè½¬æ¢
â”‚   â”‚   â””â”€â”€ types.ts             # OpenAI ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ gemini/                  # Gemini åè®®
â”‚   â”‚   â”œâ”€â”€ transformer.ts       # Gemini è½¬æ¢å™¨åŒ…è£…
â”‚   â”‚   â”œâ”€â”€ sse.ts               # SSE æµè½¬æ¢
â”‚   â”‚   â””â”€â”€ types.ts             # Gemini ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ custom/                  # è‡ªå®šä¹‰è½¬æ¢å™¨
â”‚       â”œâ”€â”€ base.ts              # è‡ªå®šä¹‰è½¬æ¢å™¨åŸºç±»
â”‚       â”œâ”€â”€ gemini-cli.ts        # Gemini CLI ç‰¹æ®Šå¤„ç†
â”‚       â””â”€â”€ registry.ts          # è‡ªå®šä¹‰è½¬æ¢å™¨æ³¨å†Œ
â”œâ”€â”€ adapters/                    # ä¿ç•™: å†…å®¹ä¿®æ”¹å±‚
â”œâ”€â”€ gateway.ts                   # ä¿®æ”¹: é›†æˆåè®®è½¬æ¢
â”œâ”€â”€ types.ts                     # æ‰©å±•: æ–°å¢åè®®ç›¸å…³ç±»å‹
â””â”€â”€ config.ts                    # æ‰©å±•: supplier auth / transformer é…ç½®æ ¡éªŒ
```

### 4.3 æ ¸å¿ƒç±»å‹è®¾è®¡

#### 4.3.1 Supplier æ‰©å±•

v1 å†³ç­–ï¼šåºŸå¼ƒ `protocolType`ï¼Œç»Ÿä¸€ç”¨ `transformer` å†³å®šè½¬æ¢é€»è¾‘ã€‚

Supplier åœ¨ç°æœ‰å­—æ®µåŸºç¡€ä¸Šæ‰©å±•ä¸¤ç±»èƒ½åŠ›ï¼š**è®¤è¯ä¿¡æ¯ï¼ˆauthï¼‰**ä¸**è½¬æ¢é“¾ï¼ˆtransformerï¼‰**ã€‚

**Supplier æ–°å¢å­—æ®µï¼ˆç»“æ„è¯´æ˜ï¼‰**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `auth` | object | å¦ï¼ˆå»ºè®®å¯ç”¨è½¬æ¢æ—¶å¿…å¡«ï¼‰ | PromptXY å­˜å‚¨å¹¶æ³¨å…¥ä¸Šæ¸¸è®¤è¯ä¿¡æ¯ |
| `transformer` | object | å¦ | åè®®è½¬æ¢é…ç½®ï¼ˆPromptXY è‡ªå®šä¹‰ç»“æ„ï¼‰ |

**auth å»ºè®®ç»“æ„ï¼ˆv1ï¼‰**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `type` | `"bearer"` \| `"header"` | æ˜¯ | è®¤è¯æ³¨å…¥æ–¹å¼ |
| `token` | string | `bearer` æ—¶æ˜¯ | å°†æ³¨å…¥ä¸º `Authorization: Bearer <token>` |
| `headerName` | string | `header` æ—¶æ˜¯ | è‡ªå®šä¹‰ header åç§° |
| `headerValue` | string | `header` æ—¶æ˜¯ | è‡ªå®šä¹‰ header å€¼ |

> å®‰å…¨è¦æ±‚ï¼šUI å±•ç¤ºæ—¶å¿…é¡»è„±æ•ï¼›è¯·æ±‚å†å²ä¸æ—¥å¿—ä¸å¾—è½ç›˜æ˜æ–‡ tokenï¼ˆè§ç¬¬ 7 ç« ï¼‰ã€‚
>
> æ³¨ï¼šä¸ºå®ç°â€œå¯¹å†…ç»Ÿä¸€ tokenã€å¯¹å¤–ä½¿ç”¨ supplier keyâ€çš„ä½“éªŒï¼Œç½‘å…³åœ¨è½¬å‘ä¸Šæ¸¸æ—¶åº”ä»¥ `supplier.auth` ä¸ºå‡†ï¼Œ**è¦†ç›–/æ›¿æ¢**å®¢æˆ·ç«¯ä¼ å…¥çš„è®¤è¯å¤´ï¼ˆè€Œä¸æ˜¯é€ä¼ ï¼‰ã€‚å®¢æˆ·ç«¯çš„ token å¯ä»¥ä»…ç”¨äºæ»¡è¶³å…¶ CLI/SDK çš„å¿…å¡«å­—æ®µæˆ–ä½œä¸ºæœ¬åœ°é‰´æƒï¼ˆåè€…å¯åœ¨åç»­ç‰ˆæœ¬æ‰©å±•ï¼‰ã€‚

**transformer æ˜¾å¼ç»“æ„ï¼ˆv1 / ç²¾ç¡®åŒ¹é…ï¼‰**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `default` | `chain` | æ˜¯ | é»˜è®¤è½¬æ¢é“¾ |
| `models` | `{ [model: string]: chain }` | å¦ | model ç²¾ç¡®åŒ¹é…è¦†ç›–é“¾ |

å…¶ä¸­ `chain` æ˜¯æ•°ç»„ï¼Œå…ƒç´ ä¸ºï¼š
- `"<transformerName>"`ï¼ˆä¸å¸¦ optionsï¼‰
- `{ "name": "<transformerName>", "options": { ... } }`ï¼ˆå¸¦ optionsï¼‰

#### 4.3.2 è½¬æ¢å™¨æ¥å£

è°ƒç ”ç»“è®ºï¼šè½¬æ¢å™¨åœ¨ v1 éœ€è¦è¦†ç›–ä¸‰ç±»èƒ½åŠ›å³å¯æ»¡è¶³è½åœ°ï¼š

1. **è¯·æ±‚è½¬æ¢**ï¼šæŠŠâ€œè¿›å…¥ PromptXY çš„è¯·æ±‚åè®®â€ï¼ˆä¼˜å…ˆä»¥ Claude Code/Anthropic Messages ä¸ºä¸»ï¼‰è½¬æ¢ä¸ºä¸Šæ¸¸åè®®ï¼ˆOpenAI compatible/Gemini ç­‰ï¼‰ã€‚
2. **å“åº”è½¬æ¢**ï¼šæŠŠä¸Šæ¸¸å“åº”è½¬æ¢å›â€œå¯¹ Claude Code å…¥å£å¯ç”¨çš„åè®®â€ï¼ˆAnthropicï¼‰ã€‚
3. **æµå¼è½¬æ¢ï¼ˆå¯é€‰ï¼‰**ï¼šè‹¥ä¸Šæ¸¸ä½¿ç”¨ SSE/æµå¼ chunkï¼Œéœ€é€äº‹ä»¶æˆ–é€ chunk è½¬æ¢ï¼›è¯¥èƒ½åŠ›ä¸ç½‘å…³å½“å‰â€œç›´æ¥ pipeâ€æ¨¡å‹å­˜åœ¨å†²çªï¼Œéœ€è¦å•ç‹¬è¯„ä¼°ä¸å®ç°ã€‚

å®ç°å±‚é¢çš„æ¥å£å½¢æ€å¯ä»¥ç”± `registry + compat layer` çº¦æŸï¼Œä¸åœ¨è°ƒç ”æ–‡æ¡£ä¸­ç»‘å®šå…·ä½“ TypeScript æ¥å£ç»†èŠ‚ï¼Œä»¥é¿å…è¿‡æ—©é”æ­»å®ç°ã€‚

#### 4.3.3 æ˜ å°„èŠ‚ç‚¹ç±»å‹ï¼ˆç”¨äºå¯è§†åŒ–ï¼‰

v1 é‡ç‚¹æ˜¯æŠŠâ€œå¯éªŒè¯çš„è½¬æ¢ç»“æœâ€äº¤ä»˜å‡ºæ¥ã€‚æ˜ å°„å¯è§†åŒ–ï¼ˆç”»å¸ƒï¼‰å±äºå¢å¼ºèƒ½åŠ›ï¼Œå»ºè®®å°†å¯è§†åŒ–æ•°æ®æ”¶æ•›åˆ°ä¸¤ç±»è¾“å‡ºï¼š

- **è½¬æ¢ traceï¼ˆå¼ºéœ€æ±‚ / v1ï¼‰**ï¼šä»¥â€œæ­¥éª¤åˆ—è¡¨ + warnings/errorsâ€çš„å½¢å¼è¾“å‡ºï¼ˆç”¨äºè°ƒè¯•ä¸éªŒè¯ UIï¼‰ã€‚  
  ä¾‹å¦‚ï¼šå‘½ä¸­ default è¿˜æ˜¯æŸä¸ª model overrideï¼›é“¾ä¸Šæ¯ä¸€æ­¥çš„è¾“å…¥/è¾“å‡ºæ‘˜è¦ï¼›å…³é”®å­—æ®µå·®å¼‚ï¼›å·¥å…·è°ƒç”¨å…¼å®¹æ€§æç¤ºç­‰ã€‚
- **æ˜ å°„å…³ç³»ï¼ˆå¼±éœ€æ±‚ / v1 å¯é€‰ï¼‰**ï¼šä»…åœ¨æˆæœ¬å¯æ§ä¸”èƒ½ç¡®ä¿æ­£ç¡®æ€§çš„å‰æä¸‹æä¾›ã€‚  
  é¿å…ä¸ºäº†ç”»å¸ƒè€Œå¼ºè¡Œæ„é€ â€œå­—æ®µçº§æ˜ å°„å›¾â€ï¼Œå¯¼è‡´å®ç°å¤æ‚åº¦ä¸ç»´æŠ¤æˆæœ¬æ€¥å‰§ä¸Šå‡ã€‚

å› æ­¤ï¼Œv1 å»ºè®®ä¼˜å…ˆå®šä¹‰ trace çš„æ•°æ®ç»“æ„ä¸ APIï¼ˆè§ç¬¬ 6 ç« é˜¶æ®µ 2ï¼‰ï¼Œç”»å¸ƒç»“æ„ï¼ˆæ ‘/å›¾èŠ‚ç‚¹ç±»å‹ï¼‰ç•™ä½œ v2+ å†å®Œå–„ã€‚

### 4.4 ç½‘å…³é›†æˆæ–¹æ¡ˆ

#### 4.4.1 è¯·æ±‚å¤„ç†æµç¨‹

åœ¨ä¸å¼•å…¥ router çš„å‰æä¸‹ï¼Œåè®®è½¬æ¢å±‚çš„æ’å…¥ç‚¹å»ºè®®ä¸ºï¼ˆå¯¹é½ç°ç½‘å…³å®ç°ï¼‰ï¼š

1. **è·¯ç”±/è·¯å¾„å¤„ç†**ï¼šä¿æŒç°çŠ¶ï¼ˆæŒ‰ `localPrefix` åŒ¹é…ã€stripPrefixã€pathMappingsã€joinUrlï¼‰ã€‚
2. **ç½‘å…³å…¥ç«™é‰´æƒï¼ˆæ–°å¢ï¼‰**ï¼šæ ¡éªŒ `gatewayAuth` tokenï¼ˆå°½æ—©å¤±è´¥ï¼Œä¸”é€šè¿‡åæ¸…ç†å…¥ç«™é‰´æƒ headerï¼‰ã€‚
3. **è¯»å–/è§£æ JSON è¯·æ±‚ä½“**ï¼šä¿æŒç°çŠ¶ï¼ˆå°½é‡ä¸æ”¹å˜â€œparse å¤±è´¥é€ä¼ â€çš„è¡Œä¸ºï¼‰ã€‚
4. **å†…å®¹ä¿®æ”¹ï¼ˆrules/adaptersï¼‰**ï¼šä¿æŒç°çŠ¶ï¼ˆæŒ‰ client é€‰æ‹© mutate é€»è¾‘ï¼‰ã€‚
5. **åè®®è½¬æ¢ï¼ˆæ–°å¢ï¼‰**ï¼šå¯¹ JSON body åšåè®®è½¬æ¢ï¼›å¹¶äº§ç”Ÿ traceï¼ˆé“¾é€‰æ‹©ã€æ­¥éª¤æ‘˜è¦ã€warnings/errorsï¼‰ã€‚
6. **ä¸Šæ¸¸è®¤è¯æ³¨å…¥ï¼ˆæ–°å¢ï¼‰**ï¼šæŒ‰ `suppliers[].auth` æ³¨å…¥æˆ–è¦†ç›–ä¸Šæ¸¸è®¤è¯å¤´ï¼ˆå®¢æˆ·ç«¯ token ä¸åº”é€ä¼ åˆ°ä¸Šæ¸¸ï¼‰ã€‚
7. **fetch è½¬å‘**ï¼šåŸºæœ¬ä¿æŒç°çŠ¶ï¼›è‹¥éœ€è¦å¯¹å“åº”åšè½¬æ¢ï¼ˆå°¤å…¶æ˜¯ SSEï¼‰ï¼Œå“åº”ä¾§å°†ä¸èƒ½ç»§ç»­ç®€å• pipeã€‚

> v1 å»ºè®®ä¼˜å…ˆæ‰“é€šâ€œè¯·æ±‚ä¾§è½¬æ¢ + éæµå¼å“åº”è½¬æ¢â€ï¼Œå¹¶é¢„ç•™æµå¼è½¬æ¢çš„å®ç°ç©ºé—´ã€‚

#### 4.4.2 SSE æµè½¬æ¢

SSE/æµå¼å“åº”è½¬æ¢æ˜¯â€œåè®®è½¬æ¢â€çš„éš¾ç‚¹ä¹‹ä¸€ï¼Œä¸”ä¸ç°ç½‘å…³çš„â€œç›´æ¥ pipeâ€æ¨¡å‹å†²çªã€‚

v1 éœ€è¦åœ¨æ–¹æ¡ˆä¸­æ˜ç¡®ä¸¤ç‚¹å®ç°è¦ç‚¹ï¼ˆä¸å±•å¼€ä»£ç ï¼‰ï¼š

1. **ä¸èƒ½ç›²ç›® pipe**ï¼šä¸€æ—¦éœ€è¦å¯¹æµå¼äº‹ä»¶åšè½¬æ¢ï¼Œå°±å¿…é¡»â€œè§£æ â†’ è½¬æ¢ â†’ åºåˆ—åŒ– â†’ å†™å›â€ã€‚
2. **äº‹ä»¶ç²’åº¦å·®å¼‚**ï¼šAnthropic ä¸ OpenAI çš„æµå¼äº‹ä»¶æ¨¡å‹ä¸åŒï¼ˆè§é™„å½• 8.1ï¼‰ï¼Œè½¬æ¢å¯èƒ½éœ€è¦ç»´æŠ¤çŠ¶æ€ï¼ˆä¾‹å¦‚ tool è°ƒç”¨çš„åˆ†ç‰‡èšåˆï¼‰ã€‚

### 4.5 è½¬æ¢å™¨æ³¨å†Œè¡¨

æ³¨å†Œè¡¨ï¼ˆregistryï¼‰çš„èŒè´£æ˜¯â€œæŠŠé…ç½®é‡Œå£°æ˜çš„ chain ç¼–è¯‘æˆå¯æ‰§è¡Œçš„è½¬æ¢ pipelineâ€ï¼Œå¹¶æä¾›ï¼š

- è½¬æ¢å™¨å­˜åœ¨æ€§æ ¡éªŒï¼ˆç”¨äºâ€œé…ç½®å¯éªŒè¯â€ï¼‰
- `default` é“¾ä¸ `models[model]` ç²¾ç¡®åŒ¹é…è¦†ç›–é“¾
- trace è¾“å‡ºï¼ˆç”¨äº UI/æ’éšœï¼‰ï¼šé“¾é€‰æ‹©ç»“æœ + æ­¥éª¤æ‘˜è¦ + warnings/errors

è¿è¡Œæ—¶é“¾é€‰æ‹©è§„åˆ™ï¼ˆv1 / ç²¾ç¡®åŒ¹é…ï¼‰ï¼š

1. å¦‚æœè¯·æ±‚é‡Œå­˜åœ¨ `model` ä¸” `transformer.models[model]` å­˜åœ¨ â†’ ä½¿ç”¨è¦†ç›–é“¾
2. å¦åˆ™ä½¿ç”¨ `transformer.default`

å®ç°ä¸Šå»ºè®®å°†â€œPromptXY è‡ªå®šä¹‰é…ç½®â€äº¤ç»™ `llms-compat` ç¼–è¯‘ä¸º `@musistudio/llms` çš„è°ƒç”¨æ–¹å¼ï¼Œä»è€Œéš”ç¦» llms çš„ config/ç‰ˆæœ¬å˜åŠ¨ã€‚

### 4.6 é…ç½®ç¤ºä¾‹

```json
{
  "listen": {
    "host": "127.0.0.1",
    "port": 3888
  },
  "gatewayAuth": {
    "enabled": true,
    "token": "pxy_xxx",
    "acceptedHeaders": ["x-api-key", "authorization", "x-goog-api-key"]
  },
  "suppliers": [
    {
      "id": "claude-entry",
      "name": "Claude Code ç»Ÿä¸€å…¥å£ï¼ˆè½¬ OpenAI å…¼å®¹ä¸Šæ¸¸ï¼‰",
      "baseUrl": "https://api.deepseek.com",
      "localPrefix": "/claude",
      "enabled": true,
      "auth": {
        "type": "bearer",
        "token": "sk_upstream_xxx"
      },
      "transformer": {
        "default": ["deepseek"],
        "models": {
          "deepseek-chat": [
            "deepseek",
            { "name": "tooluse", "options": { "mode": "strict" } }
          ]
        }
      },
      "pathMappings": [
        { "from": "/v1/messages", "to": "/chat/completions", "type": "exact" }
      ]
    }
  ],
  "rules": [],
  "storage": {
    "maxHistory": 1000
  },
  "debug": true
}
```

è¯´æ˜ï¼š
- `gatewayAuth.token`ï¼šç½‘å…³å…¥ç«™é‰´æƒ tokenï¼ˆå¯¹å†…ç»Ÿä¸€ï¼›AI å·¥å…·è®¿é—®æœ¬åœ°ç½‘å…³å¿…é¡»æºå¸¦ï¼‰ã€‚  
- `suppliers[].auth.token`ï¼šä¸Šæ¸¸ä¾›åº”å•†å¯†é’¥ï¼ˆå¯¹å¤–ï¼›ç”± PromptXY æ³¨å…¥/è¦†ç›–ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“ï¼‰ã€‚  
- `gatewayAuth.acceptedHeaders`ï¼šä»…å£°æ˜â€œä»å“ªäº› **å®¢æˆ·ç«¯åŸç”Ÿä¼šå‘é€** çš„é‰´æƒå¤´ä¸­è¯»å–ç½‘å…³ tokenâ€ã€‚v1 ä¸è¦æ±‚å®¢æˆ·ç«¯å¢åŠ è‡ªå®šä¹‰ headerï¼›è¯¥åˆ—è¡¨åº”ä»¥çœŸå®å®¢æˆ·ç«¯è¡Œä¸ºï¼ˆå°¤å…¶æ˜¯ Claude Codeï¼‰ä¸ºå‡†å¹¶å°½é‡æ”¶æ•›ã€‚

### 4.7 é…ç½®å¯éªŒè¯ç­–ç•¥ï¼ˆå¿…é¡»å…·å¤‡ï¼‰

â€œåè®®è½¬æ¢â€å±äºé«˜è€¦åˆã€é«˜å‡ºé”™æˆæœ¬çš„èƒ½åŠ›ï¼šä¸€æ—¦é…ç½®é”™äº†ï¼Œç”¨æˆ·çœ‹åˆ°çš„å¾€å¾€åªæ˜¯â€œè¯·æ±‚å¤±è´¥/æµå¼‚å¸¸/å·¥å…·ä¸å¯ç”¨â€ã€‚å› æ­¤ v1 å¿…é¡»æŠŠâ€œå¯éªŒè¯â€ä½œä¸ºä¸€ç­‰èƒ½åŠ›è®¾è®¡ï¼Œè€Œä¸æ˜¯äº‹åè¡¥æ•‘ã€‚

å»ºè®®æŠŠå¯éªŒè¯æ‹†æˆä¸‰å±‚ï¼ˆä»å¼ºåˆ°å¼±ï¼‰ï¼š

1. **å¯åŠ¨æ—¶é™æ€æ ¡éªŒï¼ˆhard failï¼‰**  
   - transformer é…ç½®ç»“æ„åˆæ³•ï¼ˆ`default/models`ã€chain step ç»“æ„ã€options ç±»å‹ç­‰ï¼‰  
   - è½¬æ¢å™¨åç§°å­˜åœ¨ï¼ˆregistry å¯åˆ—å‡ºå¯ç”¨ transformerï¼‰  
   - model è¦†ç›–ä»…å…è®¸ç²¾ç¡®åŒ¹é…ï¼ˆv1 çº¦æŸï¼‰ï¼Œé¿å…ä¸å¯é¢„æµ‹åŒ¹é…è§„åˆ™  
   - auth é…ç½®å®Œæ•´ä¸”å¯æ³¨å…¥ï¼ˆä¾‹å¦‚ bearer å¿…é¡»æœ‰ tokenï¼‰  
2. **è¿è¡Œæ—¶è¯Šæ–­ï¼ˆsoft fail + å¯è§‚æµ‹ï¼‰**  
   - å‘ç”Ÿè½¬æ¢é”™è¯¯æ—¶ï¼Œè¿”å›â€œå¯å®šä½â€çš„é”™è¯¯ä¿¡æ¯ï¼šåŒ…å« supplierã€å‘½ä¸­é“¾ï¼ˆdefault / æŸ model overrideï¼‰ã€å¤±è´¥æ­¥éª¤ã€ç®€çŸ­åŸå›   
   - debug æ¨¡å¼ä¸‹è¾“å‡º trace æ¦‚è¦ï¼ˆä¸å¾—åŒ…å«æ˜æ–‡ tokenï¼‰  
3. **äº¤äº’å¼éªŒè¯ï¼ˆUI/æ¥å£ï¼‰**  
   - æä¾›â€œé¢„è§ˆ/éªŒè¯â€èƒ½åŠ›ï¼šè¾“å…¥ç¤ºä¾‹è¯·æ±‚ï¼Œè¾“å‡º  
     - rules åè¯·æ±‚  
     - è½¬æ¢åä¸Šæ¸¸è¯·æ±‚ï¼ˆheaders/bodyï¼Œæ•æ„Ÿå­—æ®µé»˜è®¤è„±æ•ï¼‰  
     - trace/warnings/errors  

> è¿™ä¸‰å±‚èƒ½åŠ›å…±åŒä¿è¯ï¼šé…ç½®é”™è¯¯èƒ½åœ¨æœ€æ—©é˜¶æ®µæš´éœ²ï¼›é—®é¢˜å‘ç”Ÿæ—¶èƒ½å¿«é€Ÿå®šä½ï¼›ç”¨æˆ·å¯è‡ªåŠ©éªŒè¯ä¸å›å½’ã€‚

### 4.8 ç½‘å…³å…¥ç«™é‰´æƒï¼ˆGateway Authï¼Œv1 è®¡åˆ’ï¼‰

ç”±äº v1 ç›®æ ‡æ˜¯â€œå¯¹å†…ç»Ÿä¸€ URL+tokenï¼Œå¹¶åœ¨å‘½ä¸­ supplier åå°†è¯·æ±‚è½¬æ¢å¹¶è½¬å‘åˆ°è¯¥ä¸Šæ¸¸â€ï¼Œå› æ­¤ PromptXY å¿…é¡»æ”¯æŒ**ç½‘å…³å…¥ç«™é‰´æƒ**ï¼š

- **ç›®çš„**ï¼šé˜²æ­¢æœ¬æœº/å±€åŸŸç½‘ä¸­çš„å…¶å®ƒè¿›ç¨‹ç›´æ¥æ»¥ç”¨æœ¬åœ°ç½‘å…³ï¼›åŒæ—¶æŠŠâ€œå¯¹å†… tokenâ€ä¸â€œå¯¹å¤–ä¸Šæ¸¸å¯†é’¥â€è§£è€¦ã€‚
- **åŸåˆ™**ï¼šå…¥ç«™ token åªç”¨äºè®¿é—® PromptXYï¼Œæœ¬è´¨ä¸Šæ˜¯â€œç½‘å…³é‰´æƒâ€ï¼›ä¸Šæ¸¸å¯†é’¥åªç”¨äºè®¿é—®ä¾›åº”å•† APIï¼Œæœ¬è´¨ä¸Šæ˜¯â€œä¾›åº”å•†é‰´æƒâ€ã€‚

#### 4.8.1 å»ºè®®é…ç½®ç»“æ„

åœ¨ `PromptxyConfig` é¡¶å±‚å¢åŠ  `gatewayAuth`ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `enabled` | boolean | æ˜¯ | æ˜¯å¦å¯ç”¨å…¥ç«™é‰´æƒï¼ˆå»ºè®®é»˜è®¤ trueï¼‰ |
| `token` | string | `enabled=true` æ—¶æ˜¯ | å…¥ç«™é‰´æƒ token |
| `acceptedHeaders` | string[] | å¦ | æ¥å— token çš„è¯·æ±‚å¤´åˆ—è¡¨ï¼ˆä¾¿äºå…¼å®¹ä¸åŒ CLIï¼‰ |

#### 4.8.2 token ä¼ é€’æ–¹å¼ï¼ˆå…¼å®¹ä¸åŒå®¢æˆ·ç«¯ï¼‰

ç”±äºä¸åŒ AI å·¥å…·/SDK å¯¹â€œå¯è‡ªå®šä¹‰é‰´æƒå¤´â€çš„èƒ½åŠ›ä¸åŒï¼Œv1 å»ºè®®åŒæ—¶æ”¯æŒå¤šç§ header æ¥æºï¼ˆç”± `acceptedHeaders` æ§åˆ¶ï¼‰ï¼š

- **ç¡¬çº¦æŸï¼ˆv1ï¼‰**ï¼šä¸å¼•å…¥ä»»ä½• Claude Code ä¾§è‡ªå®šä¹‰ header/å­—æ®µï¼›PromptXY å¿…é¡»ä»…ä½¿ç”¨ Claude Code åè®®ä¸å…¶åŸç”Ÿä¼šå‘é€çš„é‰´æƒå¤´æ¥å®Œæˆå…¥ç«™é‰´æƒã€‚  
- **Claude/Anthropic å®¢æˆ·ç«¯**ï¼šå¯èƒ½ä¼šå‘é€ `x-api-key`ï¼ˆé€šå¸¸å¯æŠŠç½‘å…³ token é…ç½®åˆ°å…¶ API key ä½ç½®ï¼‰  
- **OpenAI/Codex å®¢æˆ·ç«¯**ï¼šå¯èƒ½ä¼šå‘é€ `Authorization: Bearer <token>`  
- **Gemini å®¢æˆ·ç«¯**ï¼šå¯èƒ½ä¼šå‘é€ `x-goog-api-key`  

> é‡è¦è¯´æ˜ï¼šç”±äº v1 é»˜è®¤ä¸å°†å…¥ç«™ request headers è½ç›˜ï¼ˆé¿å… token/secret å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼‰ï¼Œä»…å‡­è¯·æ±‚æ ·ä¾‹ fixture ä¸èƒ½æ¨æ–­ Claude Code çš„é‰´æƒå¤´åã€‚`acceptedHeaders` çš„é»˜è®¤å€¼åº”é€šè¿‡è¿è¡Œæ—¶è§‚æµ‹ï¼ˆä»…è®°å½•â€œheader åç§°/å­˜åœ¨æ€§â€ï¼Œä¸è®°å½•å€¼ï¼‰ç¡®è®¤åå†æ”¶æ•›åˆ°æœ€å°é›†åˆã€‚

æ ¡éªŒç­–ç•¥å»ºè®®ä¸ºï¼š
1. åœ¨å‘½ä¸­ supplierï¼ˆ`localPrefix`ï¼‰åã€å¤„ç† body å‰æ‰§è¡Œ token æ ¡éªŒï¼ˆå°½æ—©å¤±è´¥ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ï¼‰ã€‚
2. token æ ¡éªŒé€šè¿‡åï¼Œ**å¿…é¡»æ¸…ç†å…¥ç«™é‰´æƒç›¸å…³ header**ï¼Œé¿å…è¯¯ä¼ ç»™ä¸Šæ¸¸ã€‚
3. è½¬å‘åˆ°ä¸Šæ¸¸æ—¶ï¼Œå¿…é¡»ä»¥ `suppliers[].auth` ä¸ºå‡† **æ³¨å…¥/è¦†ç›–**ä¸Šæ¸¸è®¤è¯å¤´ã€‚

---

## 5. å¯è§†åŒ–ç•Œé¢è®¾è®¡

### 5.1 è®¾è®¡ç›®æ ‡

v1 çš„ UI é‡ç‚¹ä»â€œç”»å¸ƒæ˜ å°„ï¼ˆé‡è§£é‡Šï¼‰â€è°ƒæ•´ä¸ºâ€œå¯éªŒè¯ï¼ˆå¯è½åœ°ï¼‰â€ï¼Œä¼˜å…ˆè®©ç”¨æˆ·èƒ½ï¼š

1. **éªŒè¯é…ç½®**ï¼šå½“å‰ supplier çš„ transformer é“¾æ˜¯å¦å¯ç”¨ã€æ˜¯å¦å‘½ä¸­ model override
2. **é¢„è§ˆè½¬æ¢**ï¼šè¾“å…¥ä¸€ä»½ç¤ºä¾‹è¯·æ±‚ï¼Œçœ‹åˆ°â€œrules åè¯·æ±‚â€â€œè½¬æ¢åä¸Šæ¸¸è¯·æ±‚ï¼ˆå« auth æ³¨å…¥ç»“æœï¼‰â€
3. **æŸ¥çœ‹ trace**ï¼šè½¬æ¢é“¾é€æ­¥æ‰§è¡Œæ‘˜è¦ + warnings/errorsï¼ˆç”¨äºæ’éšœï¼‰

ç”»å¸ƒå¼æ˜ å°„å¯è§†åŒ–å¯ä½œä¸ºåç»­å¢å¼ºï¼ˆv2+ï¼‰ï¼Œé¿å…ä¸ºäº†ç”»å¸ƒå®šä¹‰å¤æ‚æ˜ å°„æ•°æ®ç»“æ„è€Œæ¨é«˜ v1 æˆæœ¬ã€‚

### 5.2 æ•´ä½“å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PromptXY - åè®®è½¬æ¢å®éªŒå®¤                    [ä¾›åº”å•†â–¼] [æ¨¡å‹â–¼] [å…¨å±] [å¯¼å‡º]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç¤ºä¾‹è¯·æ±‚ï¼ˆClaude/Anthropicï¼‰â”‚ â”‚ ä¸Šæ¸¸è¯·æ±‚é¢„è§ˆï¼ˆé»˜è®¤è„±æ•ï¼‰   â”‚ â”‚ Trace / å‘Šè­¦     â”‚  â”‚
â”‚  â”‚ - é€‰æ‹© fixture             â”‚ â”‚ - method/path/headers      â”‚ â”‚ - å‘½ä¸­é“¾(default/â”‚  â”‚
â”‚  â”‚ - ç¼–è¾‘ JSON body           â”‚ â”‚ - body diff / é«˜äº®å˜æ›´      â”‚ â”‚   model override)â”‚  â”‚
â”‚  â”‚ - stream on/off            â”‚ â”‚ - ä¸€é”®å¤åˆ¶ï¼ˆcURL / JSONï¼‰   â”‚ â”‚ - æ­¥éª¤è€—æ—¶/é”™è¯¯    â”‚  â”‚
â”‚  â”‚ [è¿è¡Œ] [é‡ç½®] [ä¿å­˜æ ·ä¾‹]    â”‚ â”‚ [å¤åˆ¶] [å±•å¼€]              â”‚ â”‚ [å¤åˆ¶trace]       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> æ³¨ï¼šv1 é»˜è®¤äº¤ä»˜â€œéªŒè¯/é¢„è§ˆ/trace å·¥ä½œå°â€ã€‚ç”»å¸ƒå¼æ˜ å°„ï¼ˆReact Flowï¼‰ä»…ä½œä¸º v2+ çš„å¯é€‰é«˜çº§è§†å›¾ï¼šåœ¨ trace/æ˜ å°„æ•°æ®ç¨³å®šä¸”å¯è§£é‡Šæ€§è¶³å¤Ÿæ—¶å†å¼•å…¥ã€‚

### 5.3 å‰ç«¯ç›®å½•ç»“æ„

```
frontend/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ protocol-canvas/           # åè®®å®éªŒå®¤ï¼ˆå¯é€‰ç”»å¸ƒè§†å›¾ï¼‰
â”‚   â”‚   â”œâ”€â”€ ProtocolCanvas.tsx     # ä¸»ç”»å¸ƒç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ canvas/
â”‚   â”‚   â”‚   â”œâ”€â”€ CanvasBackground.tsx   # ç½‘æ ¼èƒŒæ™¯
â”‚   â”‚   â”‚   â”œâ”€â”€ CanvasControls.tsx     # ç¼©æ”¾/å¹³ç§»æ§åˆ¶
â”‚   â”‚   â”‚   â””â”€â”€ CanvasMiniMap.tsx      # å°åœ°å›¾å¯¼èˆª
â”‚   â”‚   â”œâ”€â”€ nodes/
â”‚   â”‚   â”‚   â”œâ”€â”€ ProtocolNode.tsx       # åè®®èŠ‚ç‚¹å®¹å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ FieldNode.tsx          # å­—æ®µèŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ ArrayNode.tsx          # æ•°ç»„ç±»å‹èŠ‚ç‚¹
â”‚   â”‚   â”‚   â””â”€â”€ ObjectNode.tsx         # å¯¹è±¡ç±»å‹èŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ edges/
â”‚   â”‚   â”‚   â”œâ”€â”€ MappingEdge.tsx        # æ˜ å°„è¿çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ EdgeLabel.tsx          # è¿çº¿æ ‡ç­¾
â”‚   â”‚   â”‚   â””â”€â”€ EdgeAnimation.tsx      # æ•°æ®æµåŠ¨ç”»
â”‚   â”‚   â”œâ”€â”€ panels/
â”‚   â”‚   â”‚   â”œâ”€â”€ SourcePanel.tsx        # æºåè®®é¢æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ TargetPanel.tsx        # ç›®æ ‡åè®®é¢æ¿
â”‚   â”‚   â”‚   â””â”€â”€ DetailPanel.tsx        # è¯¦æƒ…é¢æ¿
â”‚   â”‚   â”œâ”€â”€ overlays/
â”‚   â”‚   â”‚   â”œâ”€â”€ TransformerOverlay.tsx # è½¬æ¢å™¨æç¤º
â”‚   â”‚   â”‚   â””â”€â”€ ValidationOverlay.tsx  # éªŒè¯æç¤º
â”‚   â”‚   â””â”€â”€ hooks/
â”‚   â”‚       â”œâ”€â”€ useCanvasLayout.ts     # å¸ƒå±€è®¡ç®—
â”‚   â”‚       â”œâ”€â”€ useNodeInteraction.ts  # èŠ‚ç‚¹äº¤äº’
â”‚   â”‚       â”œâ”€â”€ useTransformPreview.ts # è½¬æ¢é¢„è§ˆ
â”‚   â”‚       â””â”€â”€ useProtocolMapping.ts  # åè®®æ˜ å°„/trace æ•°æ®ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ suppliers/
â”‚   â”‚   â”œâ”€â”€ SupplierList.tsx           # ä¾›åº”å•†åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ SupplierForm.tsx           # ä¾›åº”å•†è¡¨å•
â”‚   â”‚   â””â”€â”€ TransformerSelector.tsx    # è½¬æ¢å™¨é€‰æ‹©å™¨
â”‚   â””â”€â”€ protocol-lab/                  # åè®®å®éªŒå®¤é¡µé¢
â”‚       â”œâ”€â”€ ProtocolLab.tsx            # ä¸»é¡µé¢
â”‚       â””â”€â”€ TestDataEditor.tsx         # æµ‹è¯•æ•°æ®ç¼–è¾‘å™¨
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ suppliers.tsx                  # ä¾›åº”å•†ç®¡ç†é¡µé¢
â”‚   â””â”€â”€ protocol-lab.tsx               # åè®®å®éªŒå®¤é¡µé¢
â””â”€â”€ api/
    â””â”€â”€ transformers.ts                # Transformer API
```

### 5.4 æŠ€æœ¯é€‰å‹

| åŠŸèƒ½ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|------|----------|------|
| **ç”»å¸ƒæ ¸å¿ƒï¼ˆå¯é€‰ï¼‰** | React Flow (@xyflow/react) | ä¸“ä¸ºèŠ‚ç‚¹å›¾è®¾è®¡ï¼ŒAPIä¸°å¯Œï¼Œæ–‡æ¡£å®Œå–„ |
| **åŠ¨ç”»ï¼ˆå¯é€‰ï¼‰** | Framer Motion | æµç•…çš„è¿‡æ¸¡åŠ¨ç”»ï¼Œä¸ React ç”Ÿæ€é›†æˆè‰¯å¥½ |
| **çŠ¶æ€ç®¡ç†** | Zustand | è½»é‡çº§ï¼Œé€‚åˆç»„ä»¶çº§çŠ¶æ€ |
| **æ ‘å¸ƒå±€** | d3-hierarchy | æˆç†Ÿçš„æ ‘å¸ƒå±€ç®—æ³• |
| **JSON è·¯å¾„** | jsonpath-plus | å®Œæ•´çš„ JSONPath æ”¯æŒ |

**æ ¸å¿ƒä¾èµ–**:

```json
{
  "dependencies": {
    "@xyflow/react": "^11.10.0",
    "framer-motion": "^11.0.0",
    "zustand": "^4.5.0",
    "d3-hierarchy": "^3.1.2",
    "jsonpath-plus": "^8.0.0"
  }
}
```

### 5.5 äº¤äº’è®¾è®¡

#### 5.5.1 äº¤äº’è¡Œä¸º

| æ“ä½œ | æ•ˆæœ |
|------|------|
| **ç‚¹å‡»èŠ‚ç‚¹** | é«˜äº®èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å…³è”è¿çº¿ |
| **ç‚¹å‡»è¿çº¿** | åœ¨è¯¦æƒ…é¢æ¿æ˜¾ç¤ºè½¬æ¢é€»è¾‘ |
| **åŒå‡»å¯¹è±¡èŠ‚ç‚¹** | å±•å¼€/æŠ˜å å­èŠ‚ç‚¹ |
| **æ‹–æ‹½èŠ‚ç‚¹** | è°ƒæ•´èŠ‚ç‚¹ä½ç½®ï¼ˆä»…æ‰‹åŠ¨å¸ƒå±€æ¨¡å¼ï¼›è‡ªåŠ¨å¸ƒå±€æ¨¡å¼ä¸‹ä¸è‡ªåŠ¨â€œåæ‹½å›å»â€ï¼‰ |
| **æ»šè½®** | ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒç¼©æ”¾ç”»å¸ƒ |
| **æ‹–æ‹½ç”»å¸ƒ** | å¹³ç§»è§†å›¾ |
| **æ‚¬åœè¿çº¿** | æ˜¾ç¤ºè½¬æ¢é€»è¾‘ tooltip |
| **æ‚¬åœè­¦å‘Š** | æ˜¾ç¤ºé—®é¢˜è¯´æ˜ |

#### 5.5.2 è¿çº¿æ ·å¼

| è½¬æ¢ç±»å‹ | é¢œè‰² | çº¿å‹ | åŠ¨ç”» |
|----------|------|------|------|
| `direct` | è“è‰² (#3b82f6) | å®çº¿ | æµåŠ¨ |
| `rename` | è“è‰² (#3b82f6) | å®çº¿ | æµåŠ¨ |
| `transform` | ç¥ç€è‰² (#f59e0b) | è™šçº¿ | æµåŠ¨ |
| `conditional` | ç´«è‰² (#8b5cf6) | ç‚¹çº¿ | æ—  |
| `error` | çº¢è‰² (#ef4444) | å®çº¿ | æ—  |
| `unmapped` | ç°è‰²è™šçº¿æ¡† | â€” | â€” |

#### 5.5.3 èŠ‚ç‚¹æ ·å¼

```typescript
// èŠ‚ç‚¹çŠ¶æ€æ ·å¼æ˜ å°„
const nodeStyles = {
  mapped: {
    border: 'border-blue-300',
    background: 'bg-white',
  },
  unmapped: {
    border: 'border-dashed border-gray-300',
    background: 'bg-gray-50',
  },
  warning: {
    border: 'border-amber-400',
    background: 'bg-amber-50',
  },
  error: {
    border: 'border-red-400',
    background: 'bg-red-50',
  },
  deprecated: {
    opacity: 'opacity-60',
  },
};
```

---

## 6. å®æ–½è®¡åˆ’

### 6.1 é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µ 1: åç«¯åè®®è½¬æ¢åŸºç¡€ (2-3 å‘¨)

**ç›®æ ‡**: å®ç°æ ¸å¿ƒåè®®è½¬æ¢åŠŸèƒ½ï¼ˆå« supplier auth æ³¨å…¥ä¸é…ç½®æ ¡éªŒï¼‰

**ä»»åŠ¡**:
1. é›†æˆ `@musistudio/llms` ä¾èµ–
2. åˆ›å»º `transformers/` æ¨¡å—ç»“æ„
3. å®ç° TransformerRegistry
4. å®ç° llms-compatï¼ˆå°† PromptXY transformer é…ç½®ç¼–è¯‘ä¸º llms è°ƒç”¨ï¼‰
5. æ‰©å±• Supplier é…ç½®ï¼šå¢åŠ  `auth` ä¸ `transformer`ï¼ˆæ˜¾å¼ç»“æ„ï¼Œmodel ç²¾ç¡®åŒ¹é…ï¼‰
6. ä¿®æ”¹ gateway.tsï¼šåœ¨ rules åæ’å…¥åè®®è½¬æ¢ï¼›å¹¶æŒ‰ supplier æ³¨å…¥è®¤è¯å¤´
7. å®ç°åŸºç¡€æµ‹è¯•ï¼ˆAnthropic â†” OpenAI compatibleï¼›å« auth æ³¨å…¥ä¸ model è¦†ç›–ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯ä»¥å°† Claude Code è¯·æ±‚è½¬æ¢ä¸º DeepSeek API æ ¼å¼
- [ ] å¯ä»¥æ­£ç¡®è½¬æ¢å“åº”
- [ ] supplier auth å¯ç”¨ä¸”ä¸ä¼šåœ¨æ—¥å¿—/å†å²ä¸­æ³„æ¼æ˜æ–‡ token
- [ ] model ç²¾ç¡®åŒ¹é…è¦†ç›–é“¾ç”Ÿæ•ˆ
- [ ] ï¼ˆå¯é€‰ï¼‰æ”¯æŒ SSE æµå¼è½¬æ¢ï¼ˆè‹¥çº³å…¥ v1 èŒƒå›´ï¼Œåˆ™ä½œä¸ºå•ç‹¬éªŒæ”¶é¡¹ï¼‰

#### é˜¶æ®µ 2: è½¬æ¢é¢„è§ˆä¸ Traceï¼ˆå¯éªŒè¯ï¼‰ (1-2 å‘¨)

**ç›®æ ‡**: å®ç°â€œå¯éªŒè¯â€çš„è½¬æ¢é¢„è§ˆä¸ trace APIï¼ˆä¼˜å…ˆäºç”»å¸ƒæ˜ å°„ï¼‰

**ä»»åŠ¡**:
1. å®šä¹‰ `transformPreview` / `transformTrace` è¾“å‡ºç»“æ„ï¼ˆè½»é‡ã€å¯è½åœ°ï¼‰
2. å®ç°é¢„è§ˆ APIï¼šè¾“å…¥ç¤ºä¾‹è¯·æ±‚ï¼Œè¾“å‡ºä¸Šæ¸¸è¯·æ±‚é¢„è§ˆï¼ˆå« auth æ³¨å…¥ç»“æœï¼‰
3. å®ç° traceï¼šé“¾é€‰æ‹©ç»“æœï¼ˆdefault vs model overrideï¼‰ã€æ­¥éª¤æ‘˜è¦ã€warnings/errors
4. æ·»åŠ å…³é”®æ ¡éªŒä¸è¯Šæ–­ä¿¡æ¯ï¼ˆç¼ºå­—æ®µã€å·¥å…·æ ¼å¼å·®å¼‚ã€stream å…¼å®¹æ€§æç¤ºï¼‰
5. API æ–‡æ¡£ç¼–å†™

**éªŒæ”¶æ ‡å‡†**:
- [ ] API èƒ½è¾“å‡ºå¯ç”¨äºæ’éšœçš„ trace
- [ ] èƒ½æ£€æµ‹å·¥å…·æ ¼å¼å·®å¼‚å¹¶ç»™å‡ºå¯è¯»æç¤º
- [ ] èƒ½è¯†åˆ«ç¼ºå¤±å­—æ®µ/ä¸æ”¯æŒç‰¹æ€§å¹¶ç»™å‡ºå‘Šè­¦
- [ ] API æ–‡æ¡£å®Œæ•´

#### é˜¶æ®µ 3: å‰ç«¯éªŒè¯ä¸é¢„è§ˆ (2-3 å‘¨)

**ç›®æ ‡**: å‰ç«¯å…ˆäº¤ä»˜â€œéªŒè¯ä¸é¢„è§ˆâ€ï¼›ç”»å¸ƒä¸ºå¯é€‰å¢å¼º

**ä»»åŠ¡**:
1. å®ç° transformer é…ç½®çš„æ ¡éªŒåé¦ˆï¼ˆé”™è¯¯/è­¦å‘Š/å¯ç”¨ï¼‰
2. å®ç°é¢„è§ˆé¡µé¢ï¼šç¤ºä¾‹è¯·æ±‚è¾“å…¥ã€ä¸Šæ¸¸è¯·æ±‚é¢„è§ˆã€trace å±•ç¤º
3. ï¼ˆå¯é€‰ï¼‰å¼•å…¥ React Flow ä½œä¸ºé«˜çº§è§†å›¾ï¼šä»…åœ¨ trace/æ˜ å°„æ•°æ®è¶³å¤Ÿç¨³å®šæ—¶å†åšç”»å¸ƒ

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç”¨æˆ·å¯åœ¨ UI ä¸­éªŒè¯æŸ supplier çš„ transformer æ˜¯å¦ç”Ÿæ•ˆ
- [ ] ç”¨æˆ·å¯çœ‹åˆ°â€œrules åè¯·æ±‚â€â€œä¸Šæ¸¸è¯·æ±‚é¢„è§ˆï¼ˆå« auth æ³¨å…¥ï¼‰â€â€œtrace/warningsâ€
- [ ] ï¼ˆå¯é€‰ï¼‰é«˜çº§ç”»å¸ƒè§†å›¾å¯ç”¨ä¸”ä¸å½±å“æ ¸å¿ƒä½“éªŒ

#### é˜¶æ®µ 4: å‰ç«¯é›†æˆä¸å®Œå–„ (1-2 å‘¨)

**ç›®æ ‡**: é›†æˆåˆ°ç°æœ‰ç•Œé¢

**ä»»åŠ¡**:
1. æ‰©å±•ä¾›åº”å•†é…ç½®è¡¨å•ï¼ˆæ·»åŠ  transformer é€‰æ‹©ï¼‰
2. åˆ›å»ºåè®®å®éªŒå®¤é¡µé¢
3. å®ç°æµ‹è¯•æ•°æ®ç¼–è¾‘å™¨
4. é›†æˆåˆ°ä¾›åº”å•†è¯¦æƒ…é¡µ
5. æ·»åŠ å¯¼å‡ºåŠŸèƒ½
6. å“åº”å¼é€‚é…

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯ä»¥åœ¨ä¾›åº”å•†ç®¡ç†ä¸­é…ç½® transformer
- [ ] ç‚¹å‡»ä¾›åº”å•†å¯ä»¥è¿›å…¥â€œè½¬æ¢é¢„è§ˆ/éªŒè¯â€è§†å›¾
- [ ] æ”¯æŒè¾“å…¥æµ‹è¯•æ•°æ®å¹¶é¢„è§ˆè½¬æ¢ç»“æœ
- [ ] ç§»åŠ¨ç«¯è‡³å°‘å¯æŸ¥çœ‹ï¼ˆåªè¯»é¢„è§ˆ/traceï¼‰ï¼Œä¸å¼ºè¡Œæ”¯æŒç”»å¸ƒäº¤äº’

#### é˜¶æ®µ 5: æµ‹è¯•ä¸ä¼˜åŒ– (1 å‘¨)

**ç›®æ ‡**: å…¨é¢æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–

**ä»»åŠ¡**:
1. ç«¯åˆ°ç«¯æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–ï¼ˆé¢„è§ˆ/trace ä¸æµå¼è½¬æ¢çš„æ€§èƒ½ï¼‰
3. é”™è¯¯å¤„ç†å®Œå–„
4. æ–‡æ¡£è¡¥å……
5. ç”¨æˆ·åé¦ˆæ”¶é›†

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰åœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] é¢„è§ˆ/trace å“åº”åŠæ—¶ï¼ˆå¯è§‚æµ‹ã€å¯æ’éšœï¼‰
- [ ] é”™è¯¯æç¤ºæ¸…æ™°
- [ ] ç”¨æˆ·æ–‡æ¡£å®Œæ•´

### 6.2 ä»»åŠ¡æ¸…å•

```markdown
## åç«¯ä»»åŠ¡

- [ ] 1.1 å®‰è£… @musistudio/llms ä¾èµ–
- [ ] 1.2 åˆ›å»º transformers/ ç›®å½•ç»“æ„
- [ ] 1.3 å®šä¹‰ PromptXY transformer é…ç½®ç»“æ„ï¼ˆdefault/models ç²¾ç¡®åŒ¹é…ï¼‰
- [ ] 1.4 å®ç° TransformerRegistryï¼ˆé“¾é€‰æ‹© + æ ¡éªŒ + traceï¼‰
- [ ] 1.5 å®ç° llms-compatï¼ˆç¼–è¯‘ PromptXY é…ç½®åˆ° llms è°ƒç”¨ï¼‰
- [ ] 1.6 æ‰©å±• Supplierï¼šå¢åŠ  authï¼ˆtoken/key å­˜å‚¨ä¸æ³¨å…¥ç­–ç•¥ï¼‰
- [ ] 1.7 ä¿®æ”¹ gateway.tsï¼šrules åæ’å…¥åè®®è½¬æ¢ + auth æ³¨å…¥
- [ ] 1.8 ï¼ˆå¯é€‰ï¼‰å®ç° SSE æµè½¬æ¢
- [ ] 1.9 æ·»åŠ è½¬æ¢é”™è¯¯å¤„ç†ä¸å¯è§‚æµ‹ trace
- [ ] 1.10 ç¼–å†™å•å…ƒ/é›†æˆæµ‹è¯•

- [ ] 2.1 å®ç° transformPreview APIï¼ˆä¸Šæ¸¸è¯·æ±‚é¢„è§ˆ + auth æ³¨å…¥ç»“æœï¼‰
- [ ] 2.2 å®ç° transformTrace APIï¼ˆé“¾é€‰æ‹© + æ­¥éª¤æ‘˜è¦ + warnings/errorsï¼‰
- [ ] 2.3 æ·»åŠ å…³é”®æ ¡éªŒä¸è¯Šæ–­ä¿¡æ¯ï¼ˆå·¥å…·å·®å¼‚ã€ç¼ºå­—æ®µã€stream æç¤ºï¼‰
- [ ] 2.4 API è·¯ç”±æ³¨å†Œ
- [ ] 2.5 API æ–‡æ¡£ç¼–å†™

## å‰ç«¯ä»»åŠ¡

- [ ] 3.1 æ‰©å±•ä¾›åº”å•†é…ç½®è¡¨å•ï¼šauth + transformerï¼ˆdefault/modelsï¼‰
- [ ] 3.2 åˆ›å»ºâ€œåè®®è½¬æ¢å®éªŒå®¤/é¢„è§ˆâ€é¡µé¢
- [ ] 3.3 å®ç°æµ‹è¯•æ•°æ®ç¼–è¾‘å™¨ï¼ˆç¤ºä¾‹è¯·æ±‚è¾“å…¥ï¼‰
- [ ] 3.4 å±•ç¤ºä¸Šæ¸¸è¯·æ±‚é¢„è§ˆï¼ˆheaders/bodyï¼Œæ•æ„Ÿå­—æ®µé»˜è®¤è„±æ•ï¼‰
- [ ] 3.5 å±•ç¤º trace/warnings/errors
- [ ] 3.6 ç¼–å†™å…³é”® UI ç»„ä»¶æµ‹è¯•ï¼ˆå¦‚æœ‰ç°æˆæµ‹è¯•ä½“ç³»ï¼‰

- [ ] 4.1 é›†æˆåˆ°ä¾›åº”å•†è¯¦æƒ…é¡µ
- [ ] 4.2 å®ç°å¯¼å‡ºï¼ˆé…ç½®/trace/é¢„è§ˆç»“æœï¼‰
- [ ] 4.3 å“åº”å¼é€‚é…ï¼ˆç§»åŠ¨ç«¯åªè¯»é¢„è§ˆä¼˜å…ˆï¼‰
- [ ] 4.4 æ·»åŠ ç”¨æˆ·å¼•å¯¼ï¼ˆè§£é‡Š default vs model overrideã€token è„±æ•ç­‰ï¼‰

## ï¼ˆå¯é€‰ï¼‰é«˜çº§ç”»å¸ƒè§†å›¾

- [ ] A.1 å®‰è£…å‰ç«¯ä¾èµ– (@xyflow/react, framer-motion)
- [ ] A.2 å®ç° ProtocolCanvasï¼ˆåŸºäºç¨³å®šçš„ trace/æ˜ å°„æ•°æ®ï¼‰

## é›†æˆæµ‹è¯•

- [ ] 5.1 ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] 5.2 æ€§èƒ½æµ‹è¯•
- [ ] 5.3 å…¼å®¹æ€§æµ‹è¯•
- [ ] 5.4 ç”¨æˆ·éªŒæ”¶æµ‹è¯•
```

---

## 7. é£é™©è¯„ä¼°ä¸ç¼“è§£

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| `@musistudio/llms` ä¸æ»¡è¶³éœ€æ±‚ | é«˜ | ä½ | æå‰è¿›è¡Œ POC éªŒè¯ï¼›ä¿ç•™è‡ªç ”é€‰é¡¹ |
| SSE æµè½¬æ¢æ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ | å®ç°æµå¼ç®¡é“ï¼›ä½¿ç”¨ TransformStream |
| å¤§åè®®æ ‘æ¸²æŸ“å¡é¡¿ï¼ˆç”»å¸ƒè§†å›¾ï¼‰ | ä¸­ | ä¸­ | è™šæ‹ŸåŒ–èŠ‚ç‚¹ï¼›æ‡’åŠ è½½å­èŠ‚ç‚¹ï¼›é»˜è®¤åªæ¸²æŸ“å¯è§å­æ ‘ |
| Transformer å…¼å®¹æ€§ | ä½ | ä¸­ | å……åˆ†æµ‹è¯•ï¼›æä¾›ç‰ˆæœ¬å…¼å®¹è¡¨ |

### 7.2 ä¾èµ–é£é™©

| ä¾èµ– | é£é™© | ç¼“è§£æªæ–½ |
|------|------|----------|
| `@musistudio/llms` | åœæ­¢ç»´æŠ¤ | æŠ½è±¡æ¥å£ï¼›å¯æ›¿æ¢å®ç° |
| `@xyflow/react` | é‡å¤§ç‰ˆæœ¬å˜æ›´ | ç‰ˆæœ¬é”å®šï¼›å…³æ³¨æ›´æ–°æ—¥å¿— |
| `framer-motion` | åŒ…ä½“ç§¯å¢åŠ  | æŒ‰éœ€å¯¼å…¥ï¼›è€ƒè™‘è½»é‡æ›¿ä»£ |

### 7.3 å®æ–½é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| å¼€å‘æ—¶é—´è¶…æœŸ | ä¸­ | ä¸­ | åˆ†é˜¶æ®µäº¤ä»˜ï¼›æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆ |
| ç”¨æˆ·ç†è§£æˆæœ¬ | ä½ | é«˜ | æä¾›è¯¦ç»†æ–‡æ¡£ï¼›æ·»åŠ äº¤äº’å¼•å¯¼ |
| ç°æœ‰é…ç½®å…¼å®¹æ€§ | ä¸­ | ä½ | æ–°å¢é…ç½®é¡¹ä½¿ç”¨å¯é€‰å­—æ®µï¼›æä¾›è¿ç§»å·¥å…· |

### 7.4 å®‰å…¨ä¸å¯†é’¥é£é™©ï¼ˆæ–°å¢ï¼‰

ç”±äº v1 å¼•å…¥â€œPromptXY å­˜å‚¨ supplier token/key å¹¶æ³¨å…¥ä¸Šæ¸¸è®¤è¯â€ï¼Œéœ€è¦æ˜¾å¼ç®¡ç†ä»¥ä¸‹é£é™©ï¼š

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| token æ˜æ–‡è½ç›˜ï¼ˆconfig/history/logï¼‰ | é«˜ | ä¸­ | é…ç½®ä¸ UI è„±æ•ï¼›å†å²è®°å½•æ¸…æ´—æ•æ„Ÿå¤´ï¼›æ—¥å¿—ç¦æ­¢è¾“å‡º tokenï¼›å¿…è¦æ—¶å¯¹å­˜å‚¨åŠ å¯† |
| é¢„è§ˆ API æ³„æ¼æ•æ„Ÿä¿¡æ¯ | é«˜ | ä¸­ | é¢„è§ˆè¾“å‡ºé»˜è®¤éšè—æ•æ„Ÿå­—æ®µï¼›ä»…åœ¨æœ¬åœ°æ˜¾å¼â€œæ˜¾ç¤ºæ˜æ–‡â€æ“ä½œä¸‹å¯è§ |
| è¯¯æ³¨å…¥è®¤è¯å¤´åˆ°é”™è¯¯ä¸Šæ¸¸ | ä¸­ | ä½ | ç»‘å®š supplier ä¸ baseUrlï¼›éªŒè¯ baseUrlï¼›ä¿æŒ `redirect: manual`ï¼ˆä¸ç°ç½‘å…³ä¸€è‡´ï¼‰ |

---

## 8. é™„å½•

### 8.1 Anthropic vs OpenAI åè®®å¯¹æ¯”

#### è¯·æ±‚æ ¼å¼

**Anthropic (Messages API)**:
```json
{
  "model": "claude-sonnet-4-20250514",
  "messages": [
    {
      "role": "user",
      "content": "Hello"
    }
  ],
  "tools": [
    {
      "name": "read_file",
      "description": "Read a file",
      "input_schema": {
        "type": "object",
        "properties": {
          "path": {
            "type": "string",
            "description": "File path"
          }
        },
        "required": ["path"]
      }
    }
  ],
  "max_tokens": 4096,
  "stream": true
}
```

**OpenAI (Chat Completions API)**:
```json
{
  "model": "gpt-4",
  "messages": [
    {
      "role": "user",
      "content": "Hello"
    }
  ],
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "read_file",
        "description": "Read a file",
        "parameters": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string",
              "description": "File path"
            }
          },
          "required": ["path"]
        }
      }
    }
  ],
  "max_tokens": 4096,
  "stream": true
}
```

**å…³é”®å·®å¼‚**:
1. `tools` æ ¼å¼ï¼šAnthropic ä½¿ç”¨æ‰å¹³ç»“æ„ï¼ŒOpenAI ä½¿ç”¨åµŒå¥— `type: function`
2. `input_schema` vs `parameters`ï¼šå­—æ®µåç§°ä¸åŒ
3. å“åº”æ ¼å¼ï¼štool_use æ ¼å¼å·®å¼‚

#### SSE å“åº”æ ¼å¼

**Anthropic**:
```
event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"tool_use","id":"toolu_01","name":"read_file"}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"input_json_delta","partial_json":"{\"path\":\""}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}
```

**OpenAI**:
```
data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1677652288,"model":"gpt-4","choices":[{"index":0,"delta":{"tool_calls":[{"index":0,"function":{"name":"read_file","arguments":"{\"path\":\""}}]}],"finish_reason":null}]}

data: [DONE]
```

### 8.2 åè®®å·®å¼‚æ€»ç»“

| åŠŸèƒ½ | Anthropic | OpenAI | Gemini |
|------|-----------|--------|--------|
| æ¶ˆæ¯æ ¼å¼ | messages[] | messages[] | contents[] |
| å·¥å…·å®šä¹‰ | tools[] | tools[] | tools[] |
| å·¥å…·è°ƒç”¨ | tool_use block | tool_calls | functionCall |
| æµå¼æ ¼å¼ | SSE events | SSE data | SSE streams |
| ç³»ç»Ÿæç¤º | system å­—æ®µ | system æ¶ˆæ¯ | systemInstruction |

### 8.3 å‚è€ƒèµ„æ–™

**æ–‡æ¡£**:
- [Anthropic Messages API](https://docs.anthropic.com/en/api/messages)
- [OpenAI Chat Completions API](https://platform.openai.com/docs/api-reference/chat/create)
- [Gemini API](https://ai.google.dev/gemini-api/docs)

**é¡¹ç›®**:
- [claude-code-router](https://github.com/musistudio/claude-code-router)
- [@musistudio/llms](https://github.com/musistudio/llms)
- [React Flow](https://reactflow.dev/)

### 8.4 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| v1.0 | 2025-01-01 | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2026-01-01 | å¯¹é½ç°ç½‘å…³è¡Œä¸ºï¼›æ”¶æ•› v1 èŒƒå›´ï¼›åºŸå¼ƒ protocolTypeï¼›å¼•å…¥ auth/token å­˜å‚¨ä¸å¯éªŒè¯ç­–ç•¥ï¼›ç²¾ç®€å¤§æ®µç¤ºæ„ä»£ç  |

### 8.5 å‚è€ƒè¯·æ±‚æ ·ä¾‹ï¼ˆç”¨äºå®ç°ä¸å›å½’ï¼‰

å®ç°åè®®è½¬æ¢å™¨æ—¶ï¼Œæœ€å®¹æ˜“è¸©å‘çš„ä¸æ˜¯â€œå­—æ®µå¯¹ç…§è¡¨â€ï¼Œè€Œæ˜¯**çœŸå®å®¢æˆ·ç«¯åœ¨çœŸå®åœºæ™¯ä¸‹å‘å‡ºçš„è¯·æ±‚å½¢æ€**ï¼ˆå°¤å…¶æ˜¯å·¥å…·è°ƒç”¨ã€æµå¼å“åº”ã€ä»¥åŠè¶…é•¿ä¸Šä¸‹æ–‡ï¼‰ã€‚

PromptXY å½“å‰å·²ä¼šæŠŠç»è¿‡ç½‘å…³çš„è¯·æ±‚è®°å½•åˆ°æœ¬æœºç›®å½•ï¼ˆé»˜è®¤ï¼‰ï¼š`~/.local/promptxy/requests/`ã€‚æ¯ä¸ªæ–‡ä»¶ä¸º `.yaml`ï¼Œæ ¸å¿ƒå­—æ®µåŒ…å«ï¼š

- `client` / `method` / `path`ï¼šç”¨äºå®šä½å…¥å£ä¸åè®®æ—
- `originalBody`ï¼šå®¢æˆ·ç«¯åŸå§‹è¯·æ±‚ä½“ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
- `modifiedBody`ï¼šç»è¿‡ rules/adapters åçš„è¯·æ±‚ä½“ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
- `responseHeaders` / `responseBody`ï¼šç”¨äºåˆ†ææµå¼ä¸å“åº”å½¢æ€ï¼ˆæ³¨æ„è„±æ•ï¼‰

> è¯´æ˜ï¼šä¸ºé¿å… token/secret è½ç›˜ï¼Œv1 è®°å½•æ ·ä¾‹é»˜è®¤ä¸åŒ…å«å…¥ç«™ `requestHeaders`ã€‚å› æ­¤è¿™äº› `.yaml` ä¸èƒ½ç”¨äºæ¨æ–­ Claude Code å®é™…å‘é€çš„é‰´æƒå¤´åï¼›`gatewayAuth.acceptedHeaders` çš„é»˜è®¤å€¼åº”é€šè¿‡è¿è¡Œæ—¶è§‚æµ‹ï¼ˆä»…è®°å½•â€œheader åç§°/å­˜åœ¨æ€§â€ï¼Œä¸è®°å½•å€¼ï¼‰ç¡®è®¤åå†æ”¶æ•›ã€‚

ä»¥ä¸‹æ˜¯å½“å‰å¯ä½œä¸º v1 è½¬æ¢å™¨å®ç°åŸºå‡†çš„ 3 ä»½å‚è€ƒè¯·æ±‚ï¼ˆæ¥è‡ªä½ æä¾›çš„æ ·æœ¬ï¼‰ï¼š

1) **Claude / Anthropic Messagesï¼ˆstream + tool_useï¼‰**  
   - æ–‡ä»¶ï¼š`~/.local/promptxy/requests/2026-01-01_20-28-00-191_7d8s25.yaml`  
   - `POST /v1/messages`ï¼ˆ`client: claude`ï¼‰  
   - body å…³é”®å½¢æ€ï¼š`model`ã€`stream: true`ã€`messages[]`ï¼ˆå« `content[]` å¤šæ®µï¼štext / tool_use / tool_resultï¼‰ã€`tools[]`

2) **Codex / OpenAI Responsesï¼ˆstream + toolsï¼‰**  
   - æ–‡ä»¶ï¼š`~/.local/promptxy/requests/2026-01-01_21-30-15-167_523jdr.yaml`  
   - `POST /responses`ï¼ˆ`client: codex`ï¼‰  
   - body å…³é”®å½¢æ€ï¼š`model`ã€`stream: true`ã€`instructions`ã€`input[]`ï¼ˆmessage itemsï¼‰ã€`tools[]`ï¼ˆfunction tools å®šä¹‰ï¼‰ã€`tool_choice`

3) **Geminiï¼ˆstreamGenerateContent + systemInstructionï¼‰**  
   - æ–‡ä»¶ï¼š`~/.local/promptxy/requests/2026-01-01_23-17-15-292_h5osz2.yaml`  
   - `POST /v1beta/models/gemini-3-flash-preview:streamGenerateContent`ï¼ˆ`client: gemini`ï¼‰  
   - body å…³é”®å½¢æ€ï¼š`systemInstruction`ã€`contents[]`ï¼ˆrole/partsï¼‰ã€`tools[]`ï¼ˆfunctionDeclarationsï¼‰ã€`generationConfig`

ä½¿ç”¨å»ºè®®ï¼š
- å°†è¿™ä¸‰ç±»è¯·æ±‚ä½œä¸º**å•å…ƒ/é›†æˆæµ‹è¯• fixture**çš„æ¥æºï¼ˆéœ€å»é™¤æˆ–æˆªæ–­è¶…é•¿æ–‡æœ¬ï¼Œä¸”å¿…é¡»è„±æ•ä»»ä½• token/secretï¼‰ã€‚
- å¯¹æ¯ä¸ª transformer è‡³å°‘è¦†ç›–ï¼šéæµå¼ + æµå¼ï¼ˆè‹¥çº³å…¥ v1ï¼‰ã€æ— å·¥å…· + æœ‰å·¥å…·ã€çŸ­æ¶ˆæ¯ + é•¿æ¶ˆæ¯ä¸‰ç»„åœºæ™¯ã€‚

---

**æ–‡æ¡£çŠ¶æ€**: ğŸŸ¡ å¾… Review
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç”¨æˆ·åé¦ˆåï¼Œå¯è¿›å…¥ææ¡ˆé˜¶æ®µ
