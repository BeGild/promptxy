## Context

PromptXY 是一个 AI 协议转换网关，当前存在严重的可见性问题，用户无法理解和使用协议转换配置。

**当前架构**:
- `ProtocolLabPage.tsx` - 协议转换实验室，用于预览和验证协议转换
- `SupplierManagement.tsx` - 供应商管理，用于添加、编辑、删除和切换供应商
- `RequestsPage.tsx` - 请求监控页面，显示请求历史和详情

**核心问题**:

1. **配置可见性缺失**:
   - 用户在"供应商管理"页面配置了多个供应商（如 supply1, supply2）
   - 但用户根本不知道当前使用的 `/claude` 路径实际对应的是哪个供应商
   - 无法快速查看和切换当前激活的供应商

2. **测试页面脱节**:
   - `ProtocolLabPage` 仅仅是做一个测试功能
   - 用户在测试页面选择的供应商和配置，与实际使用的配置没有关联
   - 测试结果无法反映真实的配置状态

3. **监控页面信息缺失**:
   - `RequestsPage` 显示请求历史，但详情页面完全没有显示：
     - 请求发送给了哪个供应商
     - 协议转换的具体情况
     - 转换链的执行过程
   - 用户无法从监控页面了解请求的实际路由和转换情况

4. **配置入口不明确**:
   - 用户不知道从哪里配置协议转换
   - "供应商管理"和"协议转换实验室"两个页面功能重叠，容易混淆
   - 缺少统一的配置入口和清晰的操作流程

**根本原因**:
- 页面之间缺乏关联和数据同步
- 配置状态和实际使用状态没有明确映射
- 缺少配置的实时可见性和透明度

**目标**:
- 提供统一的配置页面，清晰显示当前配置状态
- 让用户能够看到 `/claude` 路径实际对应的供应商
- 在监控页面显示供应商和转换信息
- 提供配置和测试的统一入口

## Goals / Non-Goals

**Goals**:
- 提供一个统一的协议转换配置页面，清晰显示当前配置状态
- 让用户能够看到 `/claude` 路径实际对应的供应商
- 在监控页面（RequestsPage）显示供应商和转换信息
- 确保配置状态和实际使用状态的明确映射
- 提供配置和测试的统一入口
- 简化用户操作流程

**Non-Goals**:
- 不实现智能推荐系统
- 不实现并行预览功能
- 不实现性能分析面板
- 不实现历史记录功能
- 不实现导出功能

## Decisions

### Decision 1: 合并页面架构

**What**: 将 `ProtocolLabPage` 和 `SupplierManagement` 合并为 `ProtocolConfigPage`

**Why**:
- 减少页面跳转，提升用户体验
- 统一配置入口，降低学习成本
- 简化状态管理

**Alternatives considered**:
1. 保持两个独立页面 - ❌ 用户体验差，需要频繁切换
2. 使用标签页合并 - ❌ 仍然存在上下文切换问题
3. 单页面合并（选择） - ✅ 最佳方案，提供统一入口

### Decision 2: 组件化设计

**What**: 将页面拆分为独立的可复用组件

**Why**:
- 提高代码可维护性
- 便于单元测试
- 支持未来扩展

**组件结构**:
```
ProtocolConfigPage
├── ToolSelector (工具选择器)
├── SupplierList (供应商列表)
├── TransformationChainView (转换链可视化)
├── TestValidation (测试验证)
└── SupplierModal (供应商弹窗)
```

### Decision 3: 简化功能集

**What**: 移除企业级复杂功能，保留核心功能

**Why**:
- 个人使用场景不需要复杂功能
- 降低维护成本
- 提升性能

**保留功能**:
- ✅ 工具选择（claude_code, codex, gemini）
- ✅ 供应商管理（添加、编辑、删除、切换）
- ✅ 转换链可视化
- ✅ 测试验证

**移除功能**:
- ❌ 智能推荐系统
- ❌ 并行预览
- ❌ 性能分析面板
- ❌ 历史记录
- ❌ 导出功能

### Decision 4: 复用现有 API 和 Hooks

**What**: 复用现有的 API endpoints 和 React Query hooks

**Why**:
- 减少开发工作量
- 保持与后端的一致性
- 避免重复代码

**复用的 Hooks**:
- `useSuppliers` - 获取供应商列表
- `useCreateSupplier` - 创建供应商
- `useUpdateSupplier` - 更新供应商
- `useDeleteSupplier` - 删除供应商
- `useToggleSupplier` - 切换供应商状态

**复用的 API**:
- `/_promptxy/suppliers` - 供应商管理 API
- `/_promptxy/transform/preview` - 协议转换预览 API

### Decision 5: 使用 HeroUI 组件库

**What**: 继续使用 HeroUI (NextUI) 组件库

**Why**:
- 项目已集成，保持一致性
- 提供丰富的组件和样式
- 良好的 TypeScript 支持

**使用的组件**:
- Card, CardBody - 卡片容器
- Button - 按钮
- Input, Select - 表单输入
- Modal, ModalContent, ModalHeader, ModalBody, ModalFooter - 弹窗
- Textarea - 文本区域
- Chip, Badge - 标签和徽章

### Decision 6: 增强请求记录存储

**What**: 在请求记录中存储供应商和转换信息

**Why**:
- 用户需要在监控页面查看请求发送给了哪个供应商
- 用户需要了解协议转换的具体情况
- 提供完整的请求追踪能力

**实现方式**:
- 在 `RequestRecord` 类型中新增字段：
  - `supplierId`: 供应商 ID
  - `supplierName`: 供应商名称
  - `transformerChain`: 使用的转换链
  - `transformTrace`: 转换追踪信息
- 后端在处理请求时记录这些信息
- 前端在请求详情中展示这些信息

### Decision 7: 增强监控页面显示

**What**: 在 RequestsPage 的详情页面中显示供应商和转换信息

**Why**:
- 用户需要从监控页面了解请求的实际路由
- 用户需要查看转换链的执行过程
- 提供完整的调试和追踪能力

**实现方式**:
- 在请求详情卡片中新增"路由信息"区域
- 显示：
  - 使用的供应商（名称和地址）
  - 转换链（可视化展示）
  - 转换追踪（每个步骤的耗时和状态）
- 提供跳转到配置页面的链接

**UI/UX 设计**:

```
┌─────────────────────────────────────────────────────────────┐
│  请求详情                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 基本信息                                              │   │
│  │ - 请求ID: xxx                                       │   │
│  │ - 时间: 2026-01-02 10:30:45                         │   │
│  │ - 耗时: 520ms                                       │   │
│  │ - 状态: ✅ 成功                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 路由信息 (新增)                                      │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │ 供应商:                                              │   │
│  │ ┌─────────────────────────────────────────────┐    │   │
│  │ │ 📦 supply1                                   │    │   │
│  │ │ https://api.anthropic.com                  │    │   │
│  │ │ [跳转到配置]                                 │    │   │
│  │ └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │ 转换链:                                              │   │
│  │ ┌─────────────────────────────────────────────┐    │   │
│  │ │ claude_code ──[anthropic]──> supply1        │    │   │
│  │ │                                              │    │   │
│  │ │ 说明: Claude 协议，无需转换，直接转发       │    │   │
│  │ │ [查看转换详情]                               │    │   │
│  │ └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │ 转换追踪: (默认折叠)                                │   │
│  │ ┌─────────────────────────────────────────────┐    │   │
│  │ │ ▼ 步骤1: anthropic (原始协议)               │    │   │
│  │ │   耗时: 0ms  状态: ✅ 成功                   │    │   │
│  │ └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 请求信息                                              │   │
│  │ - 方法: POST                                         │   │
│  │ - 路径: /v1/messages                                 │   │
│  │ - 请求体: {...}                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 响应信息                                              │   │
│  │ - 状态码: 200                                         │   │
│  │ - 响应体: {...}                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**转换详情弹窗设计**:

```
┌─────────────────────────────────────────────────────────────┐
│  转换详情                                        [×]         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  步骤1: anthropic (原始协议)                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 输入: {                                             │   │
│  │   "model": "claude-3-5-sonnet",                    │   │
│  │   "messages": [...]                                │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 输出: {                                             │   │
│  │   "model": "claude-3-5-sonnet",                    │   │
│  │   "messages": [...]                                │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  耗时: 0ms  状态: ✅ 成功                                  │
│                                                             │
│  ───────────────────────────────────────────────────────  │
│                                                             │
│  步骤2: openai (转换器)                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 输入: {                                             │   │
│  │   "model": "claude-3-5-sonnet",                    │   │
│  │   "messages": [...]                                │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 输出: {                                             │   │
│  │   "model": "gpt-4",                                 │   │
│  │   "messages": [...]                                │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  耗时: 15ms  状态: ✅ 成功                                 │
│                                                             │
│  总耗时: 15ms  状态: ✅ 成功                                  │
│                                                             │
│  [关闭]                                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**交互设计**:
- 路由信息区域默认展开，显示供应商和转换链
- 转换追踪默认折叠，只显示步骤摘要
- 点击"查看转换详情"打开弹窗，显示完整的输入/输出
- 点击"跳转到配置"打开配置页面，并选中对应的供应商
- 转换链使用简洁的文本展示，易于理解
- 使用颜色区分不同状态（成功=绿色，失败=红色）

### Decision 8: 全局配置状态指示器

**What**: 在导航栏或顶部显示当前激活的供应商

**Why**:
- 用户需要随时知道当前配置状态
- 提供快速访问配置页面的入口
- 增强配置的可见性

**实现方式**:
- 在 Header 中添加"配置状态"指示器
- 显示每个路径（/claude, /openai, /gemini）对应的供应商
- 点击跳转到配置页面
- 实时更新（配置变更后自动刷新）

## Risks / Trade-offs

### Risk 1: 状态管理复杂度

**Risk**: 合并页面可能导致状态管理复杂度增加

**Mitigation**:
- 使用 Zustand 进行状态管理
- 使用 React Query 处理数据获取
- 保持组件状态独立

### Risk 2: 测试覆盖不足

**Risk**: 新组件可能缺少充分的测试

**Mitigation**:
- 编写单元测试
- 编写集成测试
- 进行手动测试

### Risk 3: 请求详情页面UI复杂度

**Risk**: 增加协议转换信息显示可能导致请求详情页面过于复杂

**Mitigation**:
- 使用折叠/展开设计
- 提供简洁的可视化展示
- 默认折叠详细信息

### Trade-off: 功能简化 vs 完整性

**Trade-off**: 移除企业级功能可能导致部分用户需求无法满足

**Decision**: 优先满足个人使用场景，未来可以根据需求逐步添加高级功能

## Migration Plan

### Phase 1: 准备工作（1天）

1. 备份现有代码
2. 创建新的目录结构
3. 准备开发环境

### Phase 2: 核心组件开发（3-4天）

1. 实现工具选择器组件
2. 实现供应商列表组件
3. 实现转换链可视化组件
4. 实现测试验证组件
5. 实现供应商弹窗组件

### Phase 3: 集成和优化（2-3天）

1. 集成所有组件到主页面
2. 更新路由配置
3. 实现状态管理
4. 优化样式和交互

### Phase 4: 测试和文档（1-2天）

1. 编写单元测试
2. 编写集成测试
3. 进行手动测试
4. 更新文档

### Phase 5: 清理和发布（1天）

1. 删除旧代码
2. 更新项目文档
3. 代码审查
4. 发布

**回滚计划**:
- 保留旧代码的备份
- 如果新版本出现问题，可以快速回滚
- 使用 git 分支进行开发，确保主分支稳定

## Open Questions

1. **是否需要保留旧页面作为过渡？**
   - 建议：暂时保留旧页面，给用户适应时间

2. **是否需要数据迁移？**
   - 不需要，配置数据存储在后端，前端只是展示

3. **是否需要向后兼容？**
   - 不需要，这是 UI 层面的重构，不涉及 API 变更

4. **是否需要性能优化？**
   - 初期不需要，后续可以根据实际使用情况进行优化

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│  Header (导航栏)                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 配置状态: /claude → supply1  /openai → none  /gemini → none│  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ProtocolConfigPage (协议配置页面)                         │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ ToolSelector (工具选择器)                            │  │  │
│  │  │ - claude_code, codex, gemini                        │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ SupplierList (供应商列表)                            │  │  │
│  │  │ - 按协议分组显示                                    │  │  │
│  │  │ - 启用/禁用切换                                    │  │  │
│  │  │ - 编辑/删除操作                                     │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ TransformationChainView (转换链可视化)                │  │  │
│  │  │ - 简化版展示                                        │  │  │
│  │  │ - 转换详情弹窗                                      │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ TestValidation (测试验证)                            │  │  │
│  │  │ - 请求示例编辑器                                    │  │  │
│  │  │ - 运行测试                                          │  │  │
│  │  │ - 结果展示                                          │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ SupplierModal (供应商弹窗)                           │  │  │
│  │  │ - 添加/编辑表单                                     │  │  │
│  │  │ - 表单验证                                          │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ RequestsPage (请求监控页面) - 增强版                      │  │
│  ├───────────────────────────────────────────────────────────┤  │
│  │                                                           │  │
│  │  请求列表 → 点击查看详情 → 显示:                          │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ 路由信息 (新增)                                      │  │  │
│  │  │ - 供应商: supply1 (https://api.anthropic.com)       │  │  │
│  │  │ - 转换链: claude_code ──[anthropic]──> supply1     │  │  │
│  │  │ - 转换追踪: [查看详情]                               │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  原有的请求/响应信息...                                   │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据流

```
┌─────────────────────────────────────────────────────────────┐
│  配置流程                                                      │
└─────────────────────────────────────────────────────────────┘

用户在 ProtocolConfigPage 配置供应商
    ↓
切换供应商（启用/禁用）
    ↓
更新配置文件
    ↓
Header 配置状态指示器实时更新
    ↓
后端重新加载配置
    ↓
新配置生效

┌─────────────────────────────────────────────────────────────┐
│  请求流程                                                      │
└─────────────────────────────────────────────────────────────┘

客户端发送请求到 /claude
    ↓
后端匹配当前启用的供应商（supply1）
    ↓
执行协议转换（如果有）
    ↓
记录供应商和转换信息到 RequestRecord
    ↓
转发请求到上游供应商
    ↓
返回响应
    ↓
前端在 RequestsPage 显示请求详情
    ↓
显示供应商、转换链、转换追踪信息
```

## Data Flow

```
用户选择工具
    ↓
过滤可用供应商（按协议分组）
    ↓
用户选择/添加供应商
    ↓
更新转换链预览
    ↓
用户运行测试
    ↓
调用转换预览 API
    ↓
显示测试结果
    ↓
用户保存配置
    ↓
持久化到配置文件
```

## Technical Stack

- **Frontend Framework**: React 18
- **State Management**: Zustand
- **Data Fetching**: React Query
- **UI Components**: HeroUI (NextUI)
- **Styling**: Tailwind CSS
- **TypeScript**: Full type safety