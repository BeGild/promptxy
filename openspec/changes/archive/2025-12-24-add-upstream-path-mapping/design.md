## Context

å½“å‰ PromptXY çš„ä¸Šæ¸¸é…ç½®ï¼š

```typescript
upstreams: {
  anthropic: "https://api.anthropic.com",
  openai: "https://api.openai.com",
  gemini: "https://generativelanguage.googleapis.com"
}
```

å­˜åœ¨çš„é—®é¢˜ï¼š
1. å·¥å…·åç§°ï¼ˆanthropic/openai/geminiï¼‰ä¸ API åœ°å€ç¡¬ç»‘å®š
2. æ— æ³•å¿«é€Ÿåˆ‡æ¢åˆ°æµ‹è¯•ä¾›åº”å•†
3. è·¯å¾„ç›´æ¥é€ä¼ ï¼Œä¸Šæ¸¸å˜åŒ–å½±å“ CLI é…ç½®

## Goals / Non-Goals

### Goals

- æ”¯æŒé…ç½®å¤šä¸ªä¾›åº”å•†ï¼Œå¯å¿«é€Ÿåˆ‡æ¢ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- æ¯ä¸ªä¾›åº”å•†ç‹¬ç«‹é…ç½®ï¼šæœ¬åœ°è·¯å¾„å‰ç¼€ã€ä¸Šæ¸¸åœ°å€ã€è·¯å¾„æ˜ å°„
- è·¯å¾„å†²çªæ£€æµ‹ï¼šç›¸åŒ `localPrefix` çš„ä¾›åº”å•†ä¸èƒ½åŒæ—¶å¯ç”¨
- UI æä¾›ç›´è§‚çš„ä¾›åº”å•†ç®¡ç†ç•Œé¢

### Non-Goals

- ä¸åšä¾›åº”å•†è´¦å·æ± ã€è´Ÿè½½å‡è¡¡
- ä¸åšæ™ºèƒ½è·¯ç”±ï¼ˆå¦‚æŒ‰æ¨¡å‹ã€åœ°åŒºåˆ†æµï¼‰
- ä¸åšå“åº”å†…å®¹è½¬æ¢

## Decisions

### Decision 1: ä¾›åº”å•†åˆ—è¡¨æ¨¡å‹

```typescript
interface PathMapping {
  from: string;
  to: string;
  type?: 'exact' | 'prefix' | 'regex';
}

interface Supplier {
  id: string;                  // å”¯ä¸€æ ‡è¯†
  name: string;                // æ˜¾ç¤ºåç§°
  baseUrl: string;             // ä¸Šæ¸¸åœ°å€
  localPrefix: string;         // æœ¬åœ°è·¯å¾„å‰ç¼€ï¼ˆå¦‚ /claudeï¼‰
  pathMappings?: PathMapping[]; // è·¯å¾„æ˜ å°„è§„åˆ™
  enabled: boolean;            // æ˜¯å¦å¯ç”¨
}

interface PromptxyConfig {
  suppliers: Supplier[];
  // ... å…¶ä»–é…ç½®
}
```

**ç†ç”±**ï¼š
- æ•°ç»„ç»“æ„æ›´çµæ´»ï¼Œå¯ä»¥æ·»åŠ ä»»æ„æ•°é‡çš„ä¾›åº”å•†
- `enabled` å­—æ®µå®ç°å¿«é€Ÿåˆ‡æ¢ï¼Œæ— éœ€åˆ é™¤é…ç½®
- `localPrefix` å¯è‡ªå®šä¹‰ï¼Œä¸é™äº `/claude`ã€`/openai`ã€`/gemini`

### Decision 2: è·¯ç”±åŒ¹é…é€»è¾‘

```
1. è·å–æ‰€æœ‰ enabled = true çš„ä¾›åº”å•†
2. æŒ‰localPrefixé•¿åº¦é™åºæ’åºï¼ˆä¼˜å…ˆåŒ¹é…æ›´é•¿çš„å‰ç¼€ï¼‰
3. éå†æŸ¥æ‰¾åŒ¹é…çš„ localPrefix
4. æå– innerPath = pathname.slice(localPrefix.length)
5. åº”ç”¨ pathMappings è·¯å¾„æ˜ å°„
6. æ„å»ºä¸Šæ¸¸ URL å¹¶è½¬å‘
```

**ç¤ºä¾‹**ï¼š
```
è¯·æ±‚: /claude/v1/messages
  â†“
åŒ¹é…: suppliers.find(s => s.enabled && s.localPrefix === '/claude')
  â†“
æå–: innerPath = '/v1/messages'
  â†“
æ˜ å°„: åº”ç”¨ pathMappingsï¼ˆå¦‚æœ‰ï¼‰
  â†“
è½¬å‘: baseUrl + mappedPath
```

### Decision 3: è·¯å¾„å†²çªæ£€æµ‹

**è§„åˆ™**ï¼šå¯ç”¨çš„ä¾›åº”å•†ä¸èƒ½æœ‰ç›¸åŒçš„ `localPrefix`

**å®ç°**ï¼š
```typescript
function validateSuppliers(suppliers: Supplier[]): void {
  const enabledByPrefix = new Map<string, Supplier[]>();
  for (const s of suppliers) {
    if (s.enabled) {
      if (!enabledByPrefix.has(s.localPrefix)) {
        enabledByPrefix.set(s.localPrefix, []);
      }
      enabledByPrefix.get(s.localPrefix)!.push(s);
    }
  }

  for (const [prefix, suppliers] of enabledByPrefix) {
    if (suppliers.length > 1) {
      throw new Error(
        `Local prefix '${prefix}' is used by multiple enabled suppliers: ` +
        suppliers.map(s => s.name).join(', ')
      );
    }
  }
}
```

### Decision 4: UI è§†è§‰æç¤ºè®¾è®¡

**è®¾è®¡åŸåˆ™**ï¼š
- ç›¸åŒ `localPrefix` çš„ä¾›åº”å•†ç”¨**ç›¸åŒé¢œè‰²**æ ‡è¯†
- ä½¿ç”¨**å½©è‰²è§’æ ‡/å¾½ç« **ï¼Œä¸æ˜¾ç¤ºè­¦å‘Šå›¾æ ‡
- è§†è§‰æç¤ºåªæ˜¯è¾…åŠ©ä¿¡æ¯ï¼Œä¸é˜»æ­¢æ“ä½œ

**UI è®¾è®¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¾›åº”å•†ç®¡ç†                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜‘  Anthropic Official                                  â”‚   â”‚
â”‚  â”‚    ğŸŸ¦ /claude   https://api.anthropic.com               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜  Provider 1 Test                                      â”‚   â”‚
â”‚  â”‚    ğŸŸ¦ /claude   https://www.provider1.com/v1            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜‘  Test Provider                                        â”‚   â”‚
â”‚  â”‚    ğŸŸ© /test     https://www.provider2.com/v1            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜  Provider 3                                           â”‚   â”‚
â”‚  â”‚    ğŸŸª /custom   https://www.provider3.com/api/v1        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  [+ æ·»åŠ ä¾›åº”å•†]                              [ä¿å­˜é…ç½®] [é‡ç½®]   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢œè‰²åˆ†é…ç®—æ³•**ï¼š
```typescript
function getPrefixColor(prefix: string): string {
  const colors = ['ğŸŸ¦', 'ğŸŸ©', 'ğŸŸª', 'ğŸŸ§', 'ğŸŸ¥', 'â¬›'];
  const hash = prefix.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
  return colors[hash % colors.length];
}
```

### Decision 5: å¿«é€Ÿé€‰æ‹©å·²æœ‰æ˜ å°„ç«¯ç‚¹

æ·»åŠ ä¾›åº”å•†æ—¶ï¼Œæä¾›å¸¸ç”¨ `localPrefix` çš„å¿«é€Ÿé€‰æ‹©ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ·»åŠ ä¾›åº”å•†                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç§°: [__________________]             â”‚
â”‚                                         â”‚
â”‚  æœ¬åœ°è·¯å¾„å‰ç¼€:                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŸ¦ /claude    (Claude API)        â”‚ â”‚
â”‚  â”‚ ğŸŸ© /openai    (OpenAI API)        â”‚ â”‚
â”‚  â”‚ ğŸŸª /gemini    (Gemini API)        â”‚ â”‚
â”‚  â”‚ ğŸŸ§ /test      (æµ‹è¯•ç”¨)             â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚ ğŸ†• è‡ªå®šä¹‰...                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  ä¸Šæ¸¸åœ°å€: [https://_____________]     â”‚
â”‚                                         â”‚
â”‚  å¯ç”¨ä¾›åº”å•†: [â˜‘]                         â”‚
â”‚                                         â”‚
â”‚           [å–æ¶ˆ]  [ä¿å­˜]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Alternatives Considered

### æ–¹æ¡ˆ Aï¼šä¿æŒ upstreams å¯¹è±¡ç»“æ„

```typescript
upstreams: {
  claude: { baseUrl: "...", suppliers: [...] }
}
```

**æœªé‡‡ç”¨åŸå› **ï¼šå±‚çº§è¿‡æ·±ï¼Œä¸å¦‚æ‰å¹³çš„ `suppliers` æ•°ç»„ç›´è§‚ã€‚

### æ–¹æ¡ˆ Bï¼šç”¨è­¦å‘Šå›¾æ ‡æ˜¾ç¤ºå†²çª

**æœªé‡‡ç”¨åŸå› **ï¼šç”¨æˆ·åé¦ˆè­¦å‘Šå›¾æ ‡ç»™äºº"é”™è¯¯"çš„æ„Ÿè§‰ï¼Œå½©è‰²è§’æ ‡æ›´å‹å¥½ã€‚

## Routing Flow

```
è¯·æ±‚: POST /claude/v1/messages
    â†“
åŠ è½½å·²å¯ç”¨ä¾›åº”å•†
    â†“
  [
    { id: "anthropic", localPrefix: "/claude", enabled: true, ... },
    { id: "test", localPrefix: "/test", enabled: true, ... }
  ]
    â†“
æŒ‰ localPrefix é•¿åº¦é™åºæ’åº
    â†“
  [{ prefix: "/claude", len: 7 }, { prefix: "/test", len: 5 }]
    â†“
åŒ¹é…: /claude/v1/messages.startsWith("/claude") âœ“
    â†“
æå–: innerPath = "/v1/messages"
    â†“
åº”ç”¨ pathMappings (å¦‚æœ‰)
    â†“
  â”œâ”€ exact: "/v1/messages" === "/v1/messages" â†’ "/v1/messages"
  â”œâ”€ prefix: "/v1/" â†’ "/api/v1/"
  â””â”€ regex: "^/v1/(.+)$" â†’ "/api/$1"
    â†“
æ„å»º: upstreamUrl = "https://api.anthropic.com" + "/v1/messages"
    â†“
è½¬å‘: https://api.anthropic.com/v1/messages
```

## Migration Plan

æ—§é…ç½®ï¼š

```json
{
  "upstreams": {
    "anthropic": "https://api.anthropic.com",
    "openai": "https://api.openai.com",
    "gemini": "https://generativelanguage.googleapis.com"
  }
}
```

æ–°é…ç½®ï¼š

```json
{
  "suppliers": [
    {
      "id": "claude-anthropic",
      "name": "Claude (Anthropic)",
      "baseUrl": "https://api.anthropic.com",
      "localPrefix": "/claude",
      "pathMappings": [],
      "enabled": true
    },
    {
      "id": "openai-official",
      "name": "OpenAI Official",
      "baseUrl": "https://api.openai.com",
      "localPrefix": "/openai",
      "pathMappings": [],
      "enabled": true
    },
    {
      "id": "gemini-google",
      "name": "Gemini (Google)",
      "baseUrl": "https://generativelanguage.googleapis.com",
      "localPrefix": "/gemini",
      "pathMappings": [],
      "enabled": true
    }
  ]
}
```

## Open Questions

æ— ã€‚
