# 提案：重构差异视图为“叶子节点=文件”的行级文本 Diff（Meld 风格）

## 概述

本提案将 `Diff Comparison`（差异对比）视图重构为“目录树 + 文本文件差异”的交互体验：

- **左侧**：目录树（展示 `modifiedTree`，结构不变、不裁剪）
- **右侧**：以“叶子节点”为单位的**虚拟文本文件**行级差异视图（类似 meld）

核心变化点：

1. **叶子节点视为一个文件**：选择叶子节点时，把其内容渲染为文本（与“内容详情”的 text 视图语义一致），并与原始请求对应叶子节点做对比。
2. **差异为行级别**：对比粒度为 `\n` 分割后的行；空白敏感（空格/空行变化视为差异）。
3. **左右两栏对齐 + 同步滚动**：渲染为“对齐行”的双栏视图（插入/删除通过空行占位对齐），两侧使用同一滚动模型（单一虚拟列表）实现同步滚动。
4. **仅考虑内容修改**：目录树结构永远不变；不存在新增/删除“文件”（叶子节点集合与路径稳定），只比较内容差异。

## 背景与问题

当前实现存在两类根本不匹配的点：

- **结构化渲染并不等价于文本文件 diff**：把 JSON/Markdown 渲染成组件树，无法达到 diff 工具的行级对齐、同步滚动、差异块定位体验。
- **段落级 diff 不满足“像 meld 的文本 diff”**：用户希望看到“两个文本文件”的逐行变化，而不是段落摘要或结构节点差异高亮。

## 目标（Goals）

1. **行级 diff**：以文本行作为基本单元，突出显示修改行。
2. **内容语义与“内容详情”的 text 视图一致**：叶子节点内容的文本化规则与内容详情保持一致（而不是在 DiffView 重新定义一套 stringify）。
3. **对齐行渲染**：插入/删除行通过空行占位，使两侧内容在视觉上对齐（meld 风格）。
4. **同步滚动 + 虚拟化**：使用单一虚拟列表渲染两列（避免双滚动难同步），保证大文本性能可用。
5. **差异导航**：提供差异块（hunk）导航（类似 meld 的差异条/小地图），支持点击跳转。
6. **分栏可调整**：Diff 视图与内容详情共享分栏比例（最小 15%、最大 50%，比例持久化）。

## 非目标（Non-Goals）

- 不做段落级 Markdown diff（本提案以行级文本 diff 为准）。
- 不提供“仅显示变化”的过滤（始终显示全量行，仅高亮差异）。
- 不支持新增/删除文件/节点（仅内容修改；目录树结构不变化）。

## 影响范围

**受影响的规格**
- `diff-view-layout`：更新 Diff Comparison 的渲染与交互要求（行级 diff、同步滚动、叶子节点=文件）。

**受影响的代码（预期）**

- `frontend/src/components/request-viewer/components/views/DiffView.tsx`（容器与布局调整）
- `frontend/src/components/request-viewer/components/file-tree/FileTree.tsx`、`FileTreeNode.tsx`（用于联动选中/展开/定位与差异标识）
- 新增/重写 diff 组件（右侧文本 diff viewer、差异导航条等）
- `frontend/src/components/request-viewer/utils/*`（新增行级 diff 工具）

## 验收清单（Acceptance）

- [ ] 选择任意叶子节点，右侧显示两栏文本 diff，内容语义与“内容详情”的 text 视图一致
- [ ] 差异按行级别高亮，空白敏感
- [ ] 左右两栏对齐显示（插入/删除通过空行占位）
- [ ] 左右滚动同步（单一滚动模型）
- [ ] 差异导航条可跳转到差异块
- [ ] 目录树结构完整展示（不裁剪、不过滤），且结构不随对比改变
- [ ] 分栏可拖拽调整，且与内容详情共享同一比例持久化 key

